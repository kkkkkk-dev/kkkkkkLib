-- ============================================================
-- ===== KEY SYSTEM - Zero Exploiters =====
-- ============================================================

local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")
local UserInputService = game:GetService("UserInputService")
local HttpService = game:GetService("HttpService")
local Lighting = game:GetService("Lighting")
local LocalPlayer = Players.LocalPlayer

-- ===== KONFIGURASI KEY SYSTEM =====
local VALID_KEYS = {
    "ZERO-FREE-2025",
    "ZERO-VIP-ABCDE",
    "ZERO-PREMIUM-XYZ",
}

local DISCORD_LINK = "discord.gg/zeroexploiters"

local keyVerified = false
local keyAttempts = 0
local maxAttempts = 5

-- Forward declare agar bisa dipanggil dari onKeyVerified sebelum didefinisikan
local loadMainScript

-- ===== HELPER UI =====
local function makeUI(parent, class, props)
    local obj = Instance.new(class)
    for k, v in pairs(props) do obj[k] = v end
    obj.Parent = parent
    return obj
end

-- ===== KEY SYSTEM UI =====
local keyBlur = makeUI(Lighting, "BlurEffect", {Size = 24, Enabled = true})

local keyScreenGui = makeUI(LocalPlayer:WaitForChild("PlayerGui"), "ScreenGui", {
    Name = "ZeroKeySystem",
    ResetOnSpawn = false,
    DisplayOrder = 999,
    IgnoreGuiInset = true
})

local bgFrame = makeUI(keyScreenGui, "Frame", {
    Size = UDim2.new(1, 0, 1, 0),
    Position = UDim2.new(0, 0, 0, 0),
    BackgroundColor3 = Color3.fromRGB(0, 0, 0),
    BackgroundTransparency = 0.45,
    BorderSizePixel = 0,
    ZIndex = 1
})

local cardFrame = makeUI(bgFrame, "Frame", {
    AnchorPoint = Vector2.new(0.5, 0.5),
    Position = UDim2.new(0.5, 0, 0.5, 0),
    Size = UDim2.new(0, 340, 0, 295),
    BackgroundColor3 = Color3.fromRGB(18, 18, 18),
    BackgroundTransparency = 0,
    BorderSizePixel = 0,
    ZIndex = 2
})
makeUI(cardFrame, "UICorner", {CornerRadius = UDim.new(0, 14)})

makeUI(cardFrame, "ImageLabel", {
    AnchorPoint = Vector2.new(0.5, 0.5),
    Position = UDim2.new(0.5, 0, 0.5, 5),
    Size = UDim2.new(1, 24, 1, 24),
    BackgroundTransparency = 1,
    Image = "rbxassetid://5028857084",
    ImageTransparency = 0.55,
    ImageColor3 = Color3.fromRGB(0, 0, 0),
    ScaleType = Enum.ScaleType.Slice,
    SliceCenter = Rect.new(24, 24, 276, 276),
    ZIndex = -1
})

makeUI(cardFrame, "UIStroke", {
    Color = Color3.fromRGB(50, 50, 50),
    Thickness = 1.2,
    Transparency = 0.2
})

local keyGlowStroke = makeUI(cardFrame, "UIStroke", {
    Color = Color3.fromRGB(255, 255, 255),
    Thickness = 2.5,
    Transparency = 0,
    ApplyStrokeMode = Enum.ApplyStrokeMode.Border
})

local keyGlowGradient = makeUI(keyGlowStroke, "UIGradient", {
    Color = ColorSequence.new{
        ColorSequenceKeypoint.new(0, Color3.fromRGB(255, 255, 255)),
        ColorSequenceKeypoint.new(0.5, Color3.fromRGB(150, 150, 150)),
        ColorSequenceKeypoint.new(1, Color3.fromRGB(50, 50, 50))
    },
    Offset = Vector2.new(0, 0),
    Rotation = 0
})

local function animateKeyGlow()
    local rotateTween = TweenService:Create(keyGlowGradient,
        TweenInfo.new(2, Enum.EasingStyle.Sine, Enum.EasingDirection.InOut, -1, false, 0),
        {Rotation = 360}
    )
    rotateTween:Play()

    spawn(function()
        while keyScreenGui.Parent do
            for _, col in ipairs({
                Color3.fromRGB(150, 150, 150),
                Color3.fromRGB(50, 50, 50),
                Color3.fromRGB(150, 150, 150),
                Color3.fromRGB(255, 255, 255)
            }) do
                local t = TweenService:Create(keyGlowStroke,
                    TweenInfo.new(1.5, Enum.EasingStyle.Sine, Enum.EasingDirection.InOut),
                    {Color = col}
                )
                t:Play()
                t.Completed:Wait()
            end
        end
    end)

    spawn(function()
        while keyScreenGui.Parent do
            local p1 = TweenService:Create(keyGlowStroke,
                TweenInfo.new(1, Enum.EasingStyle.Sine, Enum.EasingDirection.InOut),
                {Thickness = 3.5}
            )
            p1:Play()
            p1.Completed:Wait()
            local p2 = TweenService:Create(keyGlowStroke,
                TweenInfo.new(1, Enum.EasingStyle.Sine, Enum.EasingDirection.InOut),
                {Thickness = 2.5}
            )
            p2:Play()
            p2.Completed:Wait()
        end
    end)
end
animateKeyGlow()

local keyHeader = makeUI(cardFrame, "Frame", {
    Size = UDim2.new(1, 0, 0, 36),
    Position = UDim2.new(0, 0, 0, 0),
    BackgroundColor3 = Color3.fromRGB(12, 12, 12),
    BackgroundTransparency = 0,
    BorderSizePixel = 0,
    ZIndex = 3
})
makeUI(keyHeader, "UICorner", {CornerRadius = UDim.new(0, 14)})

makeUI(keyHeader, "TextLabel", {
    Text = "Zero Exploiters  |  Key System",
    Font = Enum.Font.GothamBold,
    TextSize = 13,
    BackgroundTransparency = 1,
    TextColor3 = Color3.fromRGB(230, 230, 230),
    Size = UDim2.new(1, -20, 1, 0),
    Position = UDim2.new(0, 14, 0, 0),
    TextXAlignment = Enum.TextXAlignment.Left,
    ZIndex = 4
})

makeUI(cardFrame, "Frame", {
    Size = UDim2.new(1, 0, 0, 1),
    Position = UDim2.new(0, 0, 0, 36),
    BackgroundColor3 = Color3.fromRGB(45, 45, 45),
    BackgroundTransparency = 0,
    BorderSizePixel = 0,
    ZIndex = 3
})

makeUI(cardFrame, "TextLabel", {
    Text = "Masukkan key untuk melanjutkan",
    Font = Enum.Font.Gotham,
    TextSize = 11,
    BackgroundTransparency = 1,
    TextColor3 = Color3.fromRGB(150, 150, 150),
    Size = UDim2.new(1, -24, 0, 18),
    Position = UDim2.new(0, 12, 0, 46),
    TextXAlignment = Enum.TextXAlignment.Left,
    ZIndex = 3
})

local keyInputBg = makeUI(cardFrame, "Frame", {
    Size = UDim2.new(1, -24, 0, 38),
    Position = UDim2.new(0, 12, 0, 70),
    BackgroundColor3 = Color3.fromRGB(28, 28, 28),
    BorderSizePixel = 0,
    ZIndex = 3
})
makeUI(keyInputBg, "UICorner", {CornerRadius = UDim.new(0, 8)})

local keyInputStroke = makeUI(keyInputBg, "UIStroke", {
    Color = Color3.fromRGB(70, 70, 70),
    Thickness = 1,
    Transparency = 0.3
})

local keyInput = makeUI(keyInputBg, "TextBox", {
    Size = UDim2.new(1, -20, 1, 0),
    Position = UDim2.new(0, 10, 0, 0),
    BackgroundTransparency = 1,
    TextColor3 = Color3.fromRGB(255, 255, 255),
    Text = "",
    PlaceholderText = "Masukkan key disini...",
    PlaceholderColor3 = Color3.fromRGB(90, 90, 90),
    Font = Enum.Font.GothamBold,
    TextSize = 13,
    ClearTextOnFocus = false,
    BorderSizePixel = 0,
    TextXAlignment = Enum.TextXAlignment.Left,
    ZIndex = 4
})

local keyFeedback = makeUI(cardFrame, "TextLabel", {
    Text = "",
    Font = Enum.Font.Gotham,
    TextSize = 10,
    BackgroundTransparency = 1,
    TextColor3 = Color3.fromRGB(255, 100, 100),
    Size = UDim2.new(1, -24, 0, 16),
    Position = UDim2.new(0, 12, 0, 114),
    TextXAlignment = Enum.TextXAlignment.Left,
    ZIndex = 3
})

local verifyBtn = makeUI(cardFrame, "TextButton", {
    Size = UDim2.new(1, -24, 0, 36),
    Position = UDim2.new(0, 12, 0, 136),
    BackgroundColor3 = Color3.fromRGB(35, 120, 35),
    TextColor3 = Color3.fromRGB(255, 255, 255),
    Font = Enum.Font.GothamBold,
    TextSize = 13,
    Text = "VERIFY KEY",
    BorderSizePixel = 0,
    ZIndex = 3,
    Active = true
})
makeUI(verifyBtn, "UICorner", {CornerRadius = UDim.new(0, 8)})
makeUI(verifyBtn, "UIStroke", {
    Color = Color3.fromRGB(60, 180, 60),
    Thickness = 1,
    Transparency = 0.5
})

verifyBtn.MouseEnter:Connect(function()
    TweenService:Create(verifyBtn, TweenInfo.new(0.18), {BackgroundColor3 = Color3.fromRGB(50, 160, 50)}):Play()
end)
verifyBtn.MouseLeave:Connect(function()
    TweenService:Create(verifyBtn, TweenInfo.new(0.18), {BackgroundColor3 = Color3.fromRGB(35, 120, 35)}):Play()
end)

local discordBtn = makeUI(cardFrame, "TextButton", {
    Size = UDim2.new(1, -24, 0, 36),
    Position = UDim2.new(0, 12, 0, 180),
    BackgroundColor3 = Color3.fromRGB(30, 35, 80),
    TextColor3 = Color3.fromRGB(200, 200, 255),
    Font = Enum.Font.GothamBold,
    TextSize = 13,
    Text = "DISCORD  ( " .. DISCORD_LINK .. " )",
    BorderSizePixel = 0,
    ZIndex = 3,
    Active = true
})
makeUI(discordBtn, "UICorner", {CornerRadius = UDim.new(0, 8)})
makeUI(discordBtn, "UIStroke", {
    Color = Color3.fromRGB(80, 90, 200),
    Thickness = 1,
    Transparency = 0.4
})

discordBtn.MouseEnter:Connect(function()
    TweenService:Create(discordBtn, TweenInfo.new(0.18), {BackgroundColor3 = Color3.fromRGB(45, 50, 120)}):Play()
end)
discordBtn.MouseLeave:Connect(function()
    TweenService:Create(discordBtn, TweenInfo.new(0.18), {BackgroundColor3 = Color3.fromRGB(30, 35, 80)}):Play()
end)

discordBtn.MouseButton1Click:Connect(function()
    pcall(function()
        setclipboard(DISCORD_LINK)
    end)
    game.StarterGui:SetCore("SendNotification", {
        Title = "Discord";
        Text = "Link discord disalin! " .. DISCORD_LINK;
        Duration = 4;
    })
    TweenService:Create(discordBtn, TweenInfo.new(0.15), {BackgroundColor3 = Color3.fromRGB(80, 90, 200)}):Play()
    task.wait(0.2)
    TweenService:Create(discordBtn, TweenInfo.new(0.2), {BackgroundColor3 = Color3.fromRGB(30, 35, 80)}):Play()
end)

local attemptsLabel = makeUI(cardFrame, "TextLabel", {
    Text = "Percobaan tersisa: " .. (maxAttempts - keyAttempts),
    Font = Enum.Font.Gotham,
    TextSize = 9,
    BackgroundTransparency = 1,
    TextColor3 = Color3.fromRGB(90, 90, 90),
    Size = UDim2.new(1, -24, 0, 14),
    Position = UDim2.new(0, 12, 0, 238),
    TextXAlignment = Enum.TextXAlignment.Center,
    ZIndex = 3
})

makeUI(cardFrame, "Frame", {
    Size = UDim2.new(1, -24, 0, 1),
    Position = UDim2.new(0, 12, 0, 258),
    BackgroundColor3 = Color3.fromRGB(40, 40, 40),
    BackgroundTransparency = 0,
    BorderSizePixel = 0,
    ZIndex = 3
})

makeUI(cardFrame, "TextLabel", {
    Text = "Exploiters by kkkkkk",
    Font = Enum.Font.GothamBold,
    TextSize = 10,
    BackgroundTransparency = 1,
    TextColor3 = Color3.fromRGB(100, 100, 100),
    Size = UDim2.new(1, -24, 0, 26),
    Position = UDim2.new(0, 12, 0, 262),
    TextXAlignment = Enum.TextXAlignment.Center,
    ZIndex = 3
})

local function checkKey(inputKey)
    inputKey = inputKey:gsub("%s+", "")
    for _, validKey in ipairs(VALID_KEYS) do
        if inputKey == validKey then
            return true
        end
    end
    return false
end

local function onKeyVerified()
    keyVerified = true

    verifyBtn.Text = "VERIFIED"
    TweenService:Create(verifyBtn, TweenInfo.new(0.25, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {
        BackgroundColor3 = Color3.fromRGB(25, 185, 25)
    }):Play()
    keyFeedback.TextColor3 = Color3.fromRGB(80, 255, 80)
    keyFeedback.Text = "Key valid! Memuat script..."

    task.wait(1.0)

    local fadeDuration = 0.35
    local fadeInfo = TweenInfo.new(fadeDuration, Enum.EasingStyle.Quad, Enum.EasingDirection.Out)

    for _, child in ipairs(cardFrame:GetDescendants()) do
        pcall(function()
            local props = {}
            if child:IsA("TextLabel") or child:IsA("TextButton") or child:IsA("TextBox") then
                props.TextTransparency = 1
                props.BackgroundTransparency = 1
            elseif child:IsA("Frame") then
                props.BackgroundTransparency = 1
            elseif child:IsA("ImageLabel") then
                props.ImageTransparency = 1
                props.BackgroundTransparency = 1
            elseif child:IsA("UIStroke") then
                props.Transparency = 1
            end
            if next(props) then
                TweenService:Create(child, fadeInfo, props):Play()
            end
        end)
    end
    TweenService:Create(cardFrame, fadeInfo, {BackgroundTransparency = 1}):Play()

    task.wait(fadeDuration + 0.05)

    local slideInfo = TweenInfo.new(0.4, Enum.EasingStyle.Quad, Enum.EasingDirection.In)
    TweenService:Create(cardFrame, slideInfo, {
        Position = UDim2.new(0.5, 0, -0.15, 0)
    }):Play()

    TweenService:Create(bgFrame, TweenInfo.new(0.45, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {
        BackgroundTransparency = 1
    }):Play()
    TweenService:Create(keyBlur, TweenInfo.new(0.45, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {
        Size = 0
    }):Play()

    task.wait(0.5)

    keyScreenGui:Destroy()

    loadMainScript()
end

local function onKeyFailed()
    keyAttempts = keyAttempts + 1
    local remaining = maxAttempts - keyAttempts

    if remaining <= 0 then
        keyFeedback.TextColor3 = Color3.fromRGB(255, 50, 50)
        keyFeedback.Text = "Percobaan habis! Script dikunci."
        verifyBtn.Active = false
        verifyBtn.BackgroundColor3 = Color3.fromRGB(70, 25, 25)
        verifyBtn.Text = "TERKUNCI"
        attemptsLabel.Text = "Percobaan tersisa: 0"

        task.spawn(function()
            for i = 1, 6 do
                TweenService:Create(cardFrame, TweenInfo.new(0.05), {
                    Position = UDim2.new(0.5, (i % 2 == 0 and 10 or -10), 0.5, 0)
                }):Play()
                task.wait(0.07)
            end
            TweenService:Create(cardFrame, TweenInfo.new(0.1), {
                Position = UDim2.new(0.5, 0, 0.5, 0)
            }):Play()
        end)
        return
    end

    keyFeedback.TextColor3 = Color3.fromRGB(255, 80, 80)
    keyFeedback.Text = "Key salah! Coba lagi."
    attemptsLabel.Text = "Percobaan tersisa: " .. remaining

    TweenService:Create(keyInputBg, TweenInfo.new(0.15), {
        BackgroundColor3 = Color3.fromRGB(60, 20, 20)
    }):Play()
    task.spawn(function()
        task.wait(0.5)
        TweenService:Create(keyInputBg, TweenInfo.new(0.2), {
            BackgroundColor3 = Color3.fromRGB(28, 28, 28)
        }):Play()
    end)

    task.spawn(function()
        for i = 1, 4 do
            TweenService:Create(cardFrame, TweenInfo.new(0.05), {
                Position = UDim2.new(0.5, (i % 2 == 0 and 7 or -7), 0.5, 0)
            }):Play()
            task.wait(0.06)
        end
        TweenService:Create(cardFrame, TweenInfo.new(0.1), {
            Position = UDim2.new(0.5, 0, 0.5, 0)
        }):Play()
    end)
end

verifyBtn.MouseButton1Click:Connect(function()
    if keyVerified then return end
    local inputKey = keyInput.Text
    if inputKey == "" or inputKey == "Masukkan key disini..." then
        keyFeedback.TextColor3 = Color3.fromRGB(255, 200, 50)
        keyFeedback.Text = "Masukkan key terlebih dahulu!"
        return
    end

    verifyBtn.Text = "Memeriksa..."
    verifyBtn.Active = false
    task.wait(0.6)

    if checkKey(inputKey) then
        onKeyVerified()
    else
        verifyBtn.Text = "VERIFY KEY"
        verifyBtn.Active = true
        onKeyFailed()
    end
end)

keyInput.FocusLost:Connect(function(enterPressed)
    if enterPressed then
        verifyBtn.MouseButton1Click:Fire()
    end
end)

keyInput.Focused:Connect(function()
    TweenService:Create(keyInputBg, TweenInfo.new(0.2), {
        BackgroundColor3 = Color3.fromRGB(38, 38, 38)
    }):Play()
    TweenService:Create(keyInputStroke, TweenInfo.new(0.2), {
        Color = Color3.fromRGB(80, 180, 80),
        Transparency = 0
    }):Play()
end)
keyInput.FocusLost:Connect(function()
    TweenService:Create(keyInputBg, TweenInfo.new(0.2), {
        BackgroundColor3 = Color3.fromRGB(28, 28, 28)
    }):Play()
    TweenService:Create(keyInputStroke, TweenInfo.new(0.2), {
        Color = Color3.fromRGB(70, 70, 70),
        Transparency = 0.3
    }):Play()
end)

-- ============================================================
-- ===== MAIN SCRIPT (Dipanggil setelah key verified) =====
-- ============================================================

loadMainScript = function()

local RunService = game:GetService("RunService")
local Workspace = game:GetService("Workspace")
local Camera = Workspace.CurrentCamera
local CAS = game:GetService("ContextActionService")

-- ===== STATE VARIABEL ZERO SCRIPT =====
local NoclipEnabled = false
local InfiniteJumpEnabled = false
local GodModeEnabled = false
local AntiKickEnabled = false
local NameEspEnabled = false
local InvisibleEnabled = false
local SpyEnabled = false
local AntiLagEnabled = false 
local CheckpointEspEnabled = false

local NoclipConnection = nil
local JumpConnection = nil
local GodModeConnection = nil
local GodModeConnections = {}
local AntiKickConnection = nil
local NameEspConnection = nil
local InvisibleConnection = nil
local SpyConnection = nil
local AntiLagConnection = nil
local CheckpointEspConnection = nil
local CheckpointAddedConnection = nil

local currentWalkSpeed = 16
local currentJumpPower = 50

local NameTags = {}
local CheckpointLabels = {}
local CheckpointGui = nil
local originalProperties = {}
local originalGraphics = {}
local originalRenderSettings = {}
local antiLagConnections = {}
local antiLagCleanupList = {}

-- ===== EMOTE SYSTEM =====
local currentAnimationTrack = nil
local currentPlayButton = nil
local currentEmote = nil
local isStuck = false
local originalWalkSpeed = 16
local originalJumpPower = 50

local EmoteList = {
    {n = "Gojo Aura Farming", id = 107769522062955, imageId = 107769522062955, price = 0, ugc = true, isAnimation = false, fav = false},
    {n = "Floating on Clouds", id = 111426928948833, imageId = 111426928948833, price = 0, ugc = true, isAnimation = false, fav = false},
    {n = "Sukuna Aura Farming", id = 134893423132417, imageId = 134893423132417, price = 0, ugc = true, isAnimation = false, fav = false},
    {n = "Snoops Walk", id = 112458012124991, imageId = 112458012124991, price = 0, ugc = true, isAnimation = false, fav = false},
    {n = "Dance Moves", id = 95481300223643, imageId = 95481300223643, price = 0, ugc = true, isAnimation = false, fav = false},
    {n = "Rat Dance", id = 92853437543124, imageId = 92853437543124, price = 0, ugc = true, isAnimation = false, fav = false},
    {n = "Flying", id = 134538015837946, imageId = 134538015837946, price = 0, ugc = true, isAnimation = false, fav = false},
    {n = "Headless Floating Aura", id = 136521114251029, imageId = 136521114251029, price = 0, ugc = true, isAnimation = false, fav = false},
    {n = "Football Head", id = 89585914807224, imageId = 89585914807224, price = 0, ugc = true, isAnimation = false, fav = false},
    {n = "Floating Pose", id = 74401455185371, imageId = 74401455185371, price = 0, ugc = true, isAnimation = false, fav = false},
    {n = "Folks Drop Moves", id = 108148450243742, imageId = 108148450243742, price = 0, ugc = true, isAnimation = false, fav = false},
    {n = "Jumpstyle Dance", id = 133248139921782, imageId = 133248139921782, price = 0, ugc = true, isAnimation = false, fav = false},
    {n = "Lets Get Sturdy", id = 119341017234649, imageId = 119341017234649, price = 0, ugc = true, isAnimation = false, fav = false},
    {n = "Rakai Dance", id = 137080431878792, imageId = 137080431878792, price = 0, ugc = true, isAnimation = false, fav = false},
    {n = "Coboy Junior Dance", id = 127330863527694, imageId = 127330863527694, price = 0, ugc = true, isAnimation = false, fav = false},
    {n = "Dancing with Eyes Closed", id = 129637389787927, imageId = 129637389787927, price = 0, ugc = true, isAnimation = false, fav = false}
}

local function stopCurrentAnimation()
    isStuck = false
    local humanoid = LocalPlayer.Character and LocalPlayer.Character:FindFirstChildOfClass("Humanoid")
    if humanoid then
        for _, track in ipairs(humanoid:GetPlayingAnimationTracks()) do
            track:Stop(0.1)
        end
        humanoid.WalkSpeed = originalWalkSpeed
        humanoid.JumpPower = originalJumpPower
    end
    if currentPlayButton then
        currentPlayButton.Text = "Play"
        currentPlayButton.BackgroundColor3 = Color3.fromRGB(80, 80, 80)
    end
    currentAnimationTrack = nil
    currentPlayButton = nil
    currentEmote = nil
end

local function playAnimation(emote, button)
    stopCurrentAnimation()
    local humanoid = LocalPlayer.Character and LocalPlayer.Character:FindFirstChildOfClass("Humanoid")
    if not humanoid then return end
    currentPlayButton = button
    currentEmote = emote
    originalWalkSpeed = humanoid.WalkSpeed
    originalJumpPower = humanoid.JumpPower

    if emote.isAnimation then
        local animation = Instance.new("Animation")
        animation.AnimationId = "rbxassetid://" .. emote.id
        currentAnimationTrack = humanoid:LoadAnimation(animation)
        currentAnimationTrack:Play(0.1)
        currentAnimationTrack:AdjustWeight(100, 0)
        currentAnimationTrack.Looped = true
    else
        currentAnimationTrack = humanoid:PlayEmoteAndGetAnimTrackById(emote.id)
    end
    
    if currentAnimationTrack then
        if not emote.isAnimation then
            currentAnimationTrack.Stopped:Once(function()
                if currentEmote == emote then
                    stopCurrentAnimation()
                end
            end)
        end
        currentPlayButton.Text = "Stop"
        currentPlayButton.BackgroundColor3 = Color3.fromRGB(40, 160, 40)
    else
        stopCurrentAnimation()
    end
end

-- ===== FUNGSI INTI =====

function noclip(state)
    NoclipEnabled = state
    local character = LocalPlayer.Character
    if not character then return end
    if state and not NoclipConnection then
        NoclipConnection = RunService.Stepped:Connect(function()
            for _, part in ipairs(character:GetChildren()) do
                if part:IsA("BasePart") then part.CanCollide = false end
            end
        end)
    elseif not state and NoclipConnection then
        NoclipConnection:Disconnect()
        NoclipConnection = nil
        for _, part in ipairs(character:GetChildren()) do
            if part:IsA("BasePart") then part.CanCollide = true end
        end
    end
end

function infinityJump(state)
    InfiniteJumpEnabled = state
    local humanoid = LocalPlayer.Character and LocalPlayer.Character:FindFirstChildOfClass('Humanoid')
    if not humanoid then return end
    if state and not JumpConnection then
        JumpConnection = UserInputService.JumpRequest:Connect(function()
            humanoid:ChangeState("Jumping")
        end)
    elseif not state and JumpConnection then
        JumpConnection:Disconnect()
        JumpConnection = nil
    end
end

local function clearGodModeConnections()
    for _, conn in ipairs(GodModeConnections) do
        pcall(function() conn:Disconnect() end)
    end
    GodModeConnections = {}
    GodModeConnection = nil
end

local function setupGodMode(character)
    if not character then return end
    clearGodModeConnections()
    local humanoid = character:FindFirstChildOfClass("Humanoid")
    local hrp = character:FindFirstChild("HumanoidRootPart")
    if not humanoid or not hrp then return end

    pcall(function() humanoid.MaxHealth = 1e9 end)
    pcall(function() humanoid.Health = 1e9 end)

    local conn1 = RunService.Heartbeat:Connect(function()
        if not GodModeEnabled then return end
        pcall(function()
            if humanoid and humanoid.Parent then
                if humanoid.Health < humanoid.MaxHealth * 0.9 then
                    humanoid.Health = humanoid.MaxHealth
                end
            end
        end)
    end)
    table.insert(GodModeConnections, conn1)

    local conn2 = humanoid.HealthChanged:Connect(function(newHealth)
        if not GodModeEnabled then return end
        pcall(function()
            if newHealth < humanoid.MaxHealth then humanoid.Health = humanoid.MaxHealth end
        end)
    end)
    table.insert(GodModeConnections, conn2)

    local conn3 = humanoid.StateChanged:Connect(function(old, new)
        if not GodModeEnabled then return end
        if new == Enum.HumanoidStateType.Dead then
            pcall(function()
                humanoid:ChangeState(Enum.HumanoidStateType.GettingUp)
                humanoid.Health = humanoid.MaxHealth
            end)
        end
        if new == Enum.HumanoidStateType.Physics then
            pcall(function()
                task.wait(0.05)
                humanoid:ChangeState(Enum.HumanoidStateType.Running)
            end)
        end
    end)
    table.insert(GodModeConnections, conn3)

    local safeY = hrp.Position.Y
    local lastSafePos = hrp.CFrame
    local conn4 = RunService.Stepped:Connect(function()
        if not GodModeEnabled then return end
        pcall(function()
            if hrp and hrp.Parent then
                local posY = hrp.Position.Y
                if posY > -50 then
                    lastSafePos = hrp.CFrame
                    safeY = posY
                else
                    hrp.CFrame = lastSafePos + Vector3.new(0, 5, 0)
                    humanoid.Health = humanoid.MaxHealth
                end
            end
        end)
    end)
    table.insert(GodModeConnections, conn4)

    local ff = character:FindFirstChildOfClass("ForceField")
    if not ff then
        ff = Instance.new("ForceField")
        ff.Visible = false
        ff.Parent = character
    end

    pcall(function()
        local mt = getrawmetatable and getrawmetatable(humanoid)
        if mt then
            local oldIndex = mt.__index
            setreadonly(mt, false)
            mt.__index = function(self, key)
                if key == "TakeDamage" then return function() end end
                return oldIndex(self, key)
            end
            setreadonly(mt, true)
        end
    end)

    local conn5 = character.AncestryChanged:Connect(function(_, parent)
        if not GodModeEnabled then return end
        if not parent then
            pcall(function()
                task.wait(0.1)
                if LocalPlayer.Character ~= character then return end
                character.Parent = Workspace
            end)
        end
    end)
    table.insert(GodModeConnections, conn5)

    local conn6 = character.ChildAdded:Connect(function(child)
        if not GodModeEnabled then return end
        if child:IsA("Humanoid") then
            task.wait(0.1)
            setupGodMode(character)
        end
    end)
    table.insert(GodModeConnections, conn6)

    GodModeConnection = GodModeConnections
end

function godMode(state)
    GodModeEnabled = state
    if state then
        local character = LocalPlayer.Character
        if not character then return end
        setupGodMode(character)
    else
        clearGodModeConnections()
        local character = LocalPlayer.Character
        if character then
            local humanoid = character:FindFirstChildOfClass("Humanoid")
            local ff = character:FindFirstChildOfClass("ForceField")
            if ff then ff:Destroy() end
            if humanoid then
                pcall(function() humanoid.MaxHealth = 100 end)
                pcall(function() humanoid.Health = humanoid.MaxHealth end)
            end
        end
    end
end

function antiKick(state)
    AntiKickEnabled = state
    local character = LocalPlayer.Character
    if not character then return end
    local hrp = character:FindFirstChild("HumanoidRootPart")
    local humanoid = character:FindFirstChildOfClass("Humanoid")
    if not hrp or not humanoid then return end

    if state and not AntiKickConnection then
        local previousPosition = hrp.CFrame
        AntiKickConnection = RunService.Stepped:Connect(function()
            local currentPosition = hrp.CFrame
            if (currentPosition.Position - previousPosition.Position).Magnitude > 500 then
                hrp.CFrame = previousPosition
            end
            previousPosition = currentPosition
            if character.Parent ~= Workspace then character.Parent = Workspace end
            if humanoid.Health < 1 then humanoid.Health = 1 end
        end)
    elseif not state and AntiKickConnection then
        AntiKickConnection:Disconnect()
        AntiKickConnection = nil
    end
end

-- ESP Name
local espUpdateConnection = nil
local espCharConnections = {}

local function cleanupAllESP()
    for userId, espData in pairs(NameTags) do
        pcall(function()
            if espData.billboard and espData.billboard.Parent then espData.billboard:Destroy() end
        end)
        pcall(function()
            if espData.highlight and espData.highlight.Parent then espData.highlight:Destroy() end
        end)
    end
    NameTags = {}

    for _, conn in pairs(espCharConnections) do
        pcall(function() conn:Disconnect() end)
    end
    espCharConnections = {}

    if espUpdateConnection then
        espUpdateConnection:Disconnect()
        espUpdateConnection = nil
    end
    if NameEspConnection then
        NameEspConnection:Disconnect()
        NameEspConnection = nil
    end

    for _, player in ipairs(Players:GetPlayers()) do
        if player ~= LocalPlayer and player.Character then
            for _, obj in ipairs(player.Character:GetChildren()) do
                if obj:IsA("Highlight") and obj.Name == "ESPHighlight" then
                    pcall(function() obj:Destroy() end)
                end
            end
            local hrp = player.Character:FindFirstChild("HumanoidRootPart")
            if hrp then
                for _, obj in ipairs(hrp:GetChildren()) do
                    if obj:IsA("BillboardGui") then
                        pcall(function() obj:Destroy() end)
                    end
                end
            end
        end
    end
end

local function createNameTag(player)
    if not NameEspEnabled then return end
    if NameTags[player.UserId] or player == LocalPlayer then return end
    local character = player.Character
    if not character then return end
    local hrp = character:FindFirstChild("HumanoidRootPart")
    if not hrp then return end

    local nameTag = Instance.new("BillboardGui")
    nameTag.Name = "ESPBillboard"
    nameTag.Size = UDim2.new(0, 200, 0, 50)
    nameTag.AlwaysOnTop = true
    nameTag.StudsOffset = Vector3.new(0, 3, 0)
    nameTag.MaxDistance = math.huge
    nameTag.Parent = hrp

    local nameFrame = Instance.new("Frame")
    nameFrame.Size = UDim2.new(1, 0, 0.5, 0)
    nameFrame.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
    nameFrame.BackgroundTransparency = 0.5
    nameFrame.BorderSizePixel = 0
    nameFrame.Parent = nameTag
    Instance.new("UICorner", nameFrame).CornerRadius = UDim.new(0, 4)

    local textLabel = Instance.new("TextLabel")
    textLabel.Size = UDim2.new(1, 0, 1, 0)
    textLabel.BackgroundTransparency = 1
    textLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
    textLabel.TextScaled = true
    textLabel.Font = Enum.Font.GothamBold
    textLabel.Text = player.DisplayName .. "\n@" .. player.Name
    textLabel.TextStrokeTransparency = 0.3
    textLabel.Parent = nameFrame

    local distanceLabel = Instance.new("TextLabel")
    distanceLabel.Size = UDim2.new(1, 0, 0.5, 0)
    distanceLabel.Position = UDim2.new(0, 0, 0.5, 0)
    distanceLabel.BackgroundTransparency = 1
    distanceLabel.TextColor3 = Color3.fromRGB(100, 255, 100)
    distanceLabel.TextScaled = true
    distanceLabel.Font = Enum.Font.GothamBold
    distanceLabel.Text = "0m"
    distanceLabel.TextStrokeTransparency = 0.3
    distanceLabel.Parent = nameTag

    local highlight = Instance.new("Highlight")
    highlight.Name = "ESPHighlight"
    highlight.Adornee = character
    highlight.FillColor = Color3.fromRGB(255, 100, 100)
    highlight.OutlineColor = Color3.fromRGB(255, 255, 255)
    highlight.FillTransparency = 0.5
    highlight.OutlineTransparency = 0
    highlight.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
    highlight.Parent = character

    NameTags[player.UserId] = {
        billboard = nameTag,
        highlight = highlight,
        distanceLabel = distanceLabel,
        character = character,
        player = player
    }

    for _, part in ipairs(character:GetChildren()) do
        if (part:IsA("BasePart") or part:IsA("MeshPart")) and part.Transparency == 1 then
            part.Transparency = 0.99
        end
    end
end

local function updateESPPositions()
    if not LocalPlayer.Character or not LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then return end
    local myHRP = LocalPlayer.Character.HumanoidRootPart

    for userId, espData in pairs(NameTags) do
        if espData and espData.character and espData.character:FindFirstChild("HumanoidRootPart") then
            local targetHRP = espData.character.HumanoidRootPart
            local distance = (myHRP.Position - targetHRP.Position).Magnitude
            espData.distanceLabel.Text = string.format("%.1fm", distance)
            if distance < 50 then
                espData.distanceLabel.TextColor3 = Color3.fromRGB(255, 100, 100)
                if espData.highlight then espData.highlight.FillColor = Color3.fromRGB(255, 50, 50) end
            elseif distance < 150 then
                espData.distanceLabel.TextColor3 = Color3.fromRGB(255, 255, 100)
                if espData.highlight then espData.highlight.FillColor = Color3.fromRGB(255, 200, 50) end
            else
                espData.distanceLabel.TextColor3 = Color3.fromRGB(100, 255, 100)
                if espData.highlight then espData.highlight.FillColor = Color3.fromRGB(50, 255, 50) end
            end
            local humanoid = espData.character:FindFirstChildOfClass("Humanoid")
            if humanoid then
                espData.billboard.StudsOffset = humanoid.RigType == Enum.HumanoidRigType.R6
                    and Vector3.new(0, 3, 0) or Vector3.new(0, 3.5, 0)
            end
        else
            pcall(function()
                if espData.billboard and espData.billboard.Parent then espData.billboard:Destroy() end
            end)
            pcall(function()
                if espData.highlight and espData.highlight.Parent then espData.highlight:Destroy() end
            end)
            NameTags[userId] = nil
        end
    end
end

local function registerCharacterAdded(player)
    if espCharConnections[player.UserId] then
        pcall(function() espCharConnections[player.UserId]:Disconnect() end)
        espCharConnections[player.UserId] = nil
    end
    local conn = player.CharacterAdded:Connect(function()
        if not NameEspEnabled then return end
        if NameTags[player.UserId] then
            pcall(function()
                if NameTags[player.UserId].billboard then NameTags[player.UserId].billboard:Destroy() end
                if NameTags[player.UserId].highlight then NameTags[player.UserId].highlight:Destroy() end
            end)
            NameTags[player.UserId] = nil
        end
        task.wait(0.15)
        createNameTag(player)
    end)
    espCharConnections[player.UserId] = conn
end

function nameEsp(state)
    NameEspEnabled = state
    if not state then cleanupAllESP() return end

    for _, player in ipairs(Players:GetPlayers()) do
        if player ~= LocalPlayer then
            registerCharacterAdded(player)
            if player.Character then createNameTag(player) end
        end
    end

    NameEspConnection = Players.PlayerAdded:Connect(function(player)
        if not NameEspEnabled then return end
        registerCharacterAdded(player)
        if player.Character then createNameTag(player) end
    end)

    local playerRemovedConn = Players.PlayerRemoving:Connect(function(player)
        if NameTags[player.UserId] then
            pcall(function()
                if NameTags[player.UserId].billboard then NameTags[player.UserId].billboard:Destroy() end
                if NameTags[player.UserId].highlight then NameTags[player.UserId].highlight:Destroy() end
            end)
            NameTags[player.UserId] = nil
        end
        if espCharConnections[player.UserId] then
            pcall(function() espCharConnections[player.UserId]:Disconnect() end)
            espCharConnections[player.UserId] = nil
        end
    end)
    espCharConnections["__playerRemoving"] = playerRemovedConn

    espUpdateConnection = RunService.RenderStepped:Connect(function()
        updateESPPositions()
    end)
end

function invisible(state)
    InvisibleEnabled = state
    local character = LocalPlayer.Character
    if not character then return end
    task.spawn(function()
        if state then
            for _, part in ipairs(character:GetChildren()) do
                if part:IsA("BasePart") or part:IsA("MeshPart") then
                    originalProperties[part] = {Transparency = part.Transparency, CanCollide = part.CanCollide}
                    part.Transparency = 1
                    part.CanCollide = false
                end
            end
        else
            for _, part in ipairs(character:GetChildren()) do
                local original = originalProperties[part]
                if original then
                    part.Transparency = original.Transparency
                    part.CanCollide = original.CanCollide
                end
            end
            originalProperties = {}
        end
        local humanoid = character:FindFirstChildOfClass('Humanoid')
        if humanoid then
            humanoid.DisplayDistanceType = state and Enum.HumanoidDisplayDistanceType.None or Enum.HumanoidDisplayDistanceType.Model
        end
    end)
end

local function applyWalkSpeed(character, speed)
    local humanoid = character:FindFirstChildOfClass("Humanoid")
    if humanoid then humanoid.WalkSpeed = speed end
end

local function applyJumpPower(character, power)
    local humanoid = character:FindFirstChildOfClass("Humanoid")
    if humanoid then
        pcall(function() humanoid.UseJumpPower = true; humanoid.JumpPower = power end)
        pcall(function() humanoid.UseJumpPower = false; humanoid.JumpHeight = power / 4 end)
    end
end

-- Spy
local spyTarget = nil
local spyCameraOffset = Vector3.new(0, 5, 15)
local spyRotation = 0
local spyPitch = 0.3
local spyConnections = {}
local spyControlGui = nil
local spyHudGui = nil
local spyOriginalCFrame = nil

local function syncLocalCharacterToTarget(_targetHRP) end

local function createSpyHUD(targetPlayer)
    if spyHudGui then spyHudGui:Destroy() end
    spyHudGui = Instance.new("ScreenGui")
    spyHudGui.Name = "SpyHUD"
    spyHudGui.ResetOnSpawn = false
    spyHudGui.DisplayOrder = 999
    spyHudGui.Parent = LocalPlayer:WaitForChild("PlayerGui")

    local panel = Instance.new("Frame")
    panel.Size = UDim2.new(0, 220, 0, 90)
    panel.Position = UDim2.new(0, 10, 0, 10)
    panel.BackgroundColor3 = Color3.fromRGB(15, 15, 15)
    panel.BackgroundTransparency = 0.3
    panel.BorderSizePixel = 0
    panel.Parent = spyHudGui
    Instance.new("UICorner", panel).CornerRadius = UDim.new(0, 8)
    local pad = Instance.new("UIPadding", panel)
    pad.PaddingLeft = UDim.new(0, 10)
    pad.PaddingTop = UDim.new(0, 8)
    local stroke_ = Instance.new("UIStroke", panel)
    stroke_.Color = Color3.fromRGB(255, 80, 80)
    stroke_.Thickness = 1.5
    stroke_.Transparency = 0.3

    local titleLabel = Instance.new("TextLabel")
    titleLabel.Size = UDim2.new(1, -10, 0, 18)
    titleLabel.BackgroundTransparency = 1
    titleLabel.TextColor3 = Color3.fromRGB(255, 80, 80)
    titleLabel.Font = Enum.Font.GothamBold
    titleLabel.TextSize = 11
    titleLabel.TextXAlignment = Enum.TextXAlignment.Left
    titleLabel.Text = "SPY MODE AKTIF"
    titleLabel.Parent = panel

    local nameLabel = Instance.new("TextLabel")
    nameLabel.Size = UDim2.new(1, -10, 0, 16)
    nameLabel.Position = UDim2.new(0, 0, 0, 22)
    nameLabel.BackgroundTransparency = 1
    nameLabel.TextColor3 = Color3.fromRGB(220, 220, 220)
    nameLabel.Font = Enum.Font.Gotham
    nameLabel.TextSize = 11
    nameLabel.TextXAlignment = Enum.TextXAlignment.Left
    nameLabel.Text = targetPlayer.DisplayName .. " (@" .. targetPlayer.Name .. ")"
    nameLabel.Parent = panel

    local posLabel = Instance.new("TextLabel")
    posLabel.Name = "PosLabel"
    posLabel.Size = UDim2.new(1, -10, 0, 14)
    posLabel.Position = UDim2.new(0, 0, 0, 42)
    posLabel.BackgroundTransparency = 1
    posLabel.TextColor3 = Color3.fromRGB(150, 220, 255)
    posLabel.Font = Enum.Font.Gotham
    posLabel.TextSize = 10
    posLabel.TextXAlignment = Enum.TextXAlignment.Left
    posLabel.Text = "X:0  Y:0  Z:0"
    posLabel.Parent = panel

    local hpLabel = Instance.new("TextLabel")
    hpLabel.Name = "HpLabel"
    hpLabel.Size = UDim2.new(1, -10, 0, 14)
    hpLabel.Position = UDim2.new(0, 0, 0, 58)
    hpLabel.BackgroundTransparency = 1
    hpLabel.TextColor3 = Color3.fromRGB(100, 255, 120)
    hpLabel.Font = Enum.Font.Gotham
    hpLabel.TextSize = 10
    hpLabel.TextXAlignment = Enum.TextXAlignment.Left
    hpLabel.Text = "HP: --"
    hpLabel.Parent = panel

    local stopBtn = Instance.new("TextButton")
    stopBtn.Size = UDim2.new(0, 60, 0, 22)
    stopBtn.Position = UDim2.new(1, -70, 0, 10)
    stopBtn.BackgroundColor3 = Color3.fromRGB(180, 40, 40)
    stopBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
    stopBtn.Font = Enum.Font.GothamBold
    stopBtn.TextSize = 10
    stopBtn.Text = "STOP SPY"
    stopBtn.BorderSizePixel = 0
    stopBtn.Parent = spyHudGui
    Instance.new("UICorner", stopBtn).CornerRadius = UDim.new(0, 6)
    stopBtn.MouseButton1Click:Connect(function() spy(nil) end)

    local tipsLabel = Instance.new("TextLabel")
    tipsLabel.Size = UDim2.new(0, 220, 0, 14)
    tipsLabel.Position = UDim2.new(0, 10, 0, 108)
    tipsLabel.BackgroundTransparency = 1
    tipsLabel.TextColor3 = Color3.fromRGB(160, 160, 160)
    tipsLabel.Font = Enum.Font.Gotham
    tipsLabel.TextSize = 9
    tipsLabel.TextXAlignment = Enum.TextXAlignment.Left
    tipsLabel.Text = "Klik Kanan+Drag=Rotasi  WASD=Geser  F=Reset"
    tipsLabel.Parent = spyHudGui

    return spyHudGui, posLabel, hpLabel
end

function spy(targetName)
    if SpyConnection then
        if type(SpyConnection) == "function" then SpyConnection()
        else SpyConnection:Disconnect() end
        SpyConnection = nil
        Workspace.CurrentCamera.CameraType = Enum.CameraType.Custom
        SpyEnabled = false
        spyTarget = nil
    end

    if spyControlGui then spyControlGui:Destroy(); spyControlGui = nil end
    if spyHudGui then spyHudGui:Destroy(); spyHudGui = nil end

    for _, conn in ipairs(spyConnections) do
        if conn and conn.Disconnect then conn:Disconnect() end
    end
    spyConnections = {}
    spyRotation = 0
    spyPitch = 0.3
    spyCameraOffset = Vector3.new(0, 5, 15)

    if not (targetName and targetName ~= "") then return end

    local targetPlayer = nil
    for _, player in ipairs(Players:GetPlayers()) do
        if player.Name:lower() == targetName:lower() or player.DisplayName:lower() == targetName:lower() then
            targetPlayer = player
            break
        end
    end

    if not (targetPlayer and targetPlayer.Character and targetPlayer.Character:FindFirstChild("HumanoidRootPart")) then
        warn("Player '" .. targetName .. "' tidak ditemukan atau belum spawn!")
        return
    end

    SpyEnabled = true
    spyTarget = targetPlayer
    local myChar = LocalPlayer.Character
    local myHRP = myChar and myChar:FindFirstChild("HumanoidRootPart")
    spyOriginalCFrame = myHRP and myHRP.CFrame or nil

    if InvisibleEnabled then invisible(false) end
    Workspace.CurrentCamera.CameraType = Enum.CameraType.Scriptable

    local _, posLabel, hpLabel = createSpyHUD(targetPlayer)

    local moveSpeed = 0.4
    local zoomDistance = 15
    local cameraManualOffset = Vector3.new(0, 0, 0)
    local keysPressed = {}

    local isMobile = UserInputService.TouchEnabled and not UserInputService.KeyboardEnabled

    if isMobile then
        spyControlGui = Instance.new("ScreenGui")
        spyControlGui.Name = "SpyControls"
        spyControlGui.ResetOnSpawn = false
        spyControlGui.Parent = LocalPlayer:WaitForChild("PlayerGui")

        local rotationTouch = nil
        local lastTouchPos = nil
        local touchRotateBegin = UserInputService.TouchStarted:Connect(function(input, gameProcessed)
            if not gameProcessed and input.Position.X > 180 then
                rotationTouch = input; lastTouchPos = input.Position
            end
        end)
        table.insert(spyConnections, touchRotateBegin)

        local touchRotateMove = UserInputService.TouchMoved:Connect(function(input)
            if input == rotationTouch and lastTouchPos then
                local delta = input.Position - lastTouchPos
                spyRotation = spyRotation - (delta.X * 0.008)
                spyPitch = math.clamp(spyPitch - (delta.Y * 0.005), -1.2, 1.2)
                lastTouchPos = input.Position
            end
        end)
        table.insert(spyConnections, touchRotateMove)

        local touchRotateEnd = UserInputService.TouchEnded:Connect(function(input)
            if input == rotationTouch then rotationTouch = nil; lastTouchPos = nil end
        end)
        table.insert(spyConnections, touchRotateEnd)
    end

    local keyInputBegan2 = UserInputService.InputBegan:Connect(function(input, gameProcessed)
        if gameProcessed then return end
        local kc = input.KeyCode
        if kc == Enum.KeyCode.W then keysPressed.W = true
        elseif kc == Enum.KeyCode.A then keysPressed.A = true
        elseif kc == Enum.KeyCode.S then keysPressed.S = true
        elseif kc == Enum.KeyCode.D then keysPressed.D = true
        elseif kc == Enum.KeyCode.Q then keysPressed.Q = true
        elseif kc == Enum.KeyCode.E then keysPressed.E = true
        elseif kc == Enum.KeyCode.Space then keysPressed.Space = true
        elseif kc == Enum.KeyCode.LeftShift then keysPressed.LeftShift = true
        elseif kc == Enum.KeyCode.F then
            cameraManualOffset = Vector3.new(0, 0, 0)
            zoomDistance = 15; spyPitch = 0.3; spyRotation = 0
        end
    end)
    table.insert(spyConnections, keyInputBegan2)

    local keyInputEnded2 = UserInputService.InputEnded:Connect(function(input)
        local kc = input.KeyCode
        if kc == Enum.KeyCode.W then keysPressed.W = false
        elseif kc == Enum.KeyCode.A then keysPressed.A = false
        elseif kc == Enum.KeyCode.S then keysPressed.S = false
        elseif kc == Enum.KeyCode.D then keysPressed.D = false
        elseif kc == Enum.KeyCode.Q then keysPressed.Q = false
        elseif kc == Enum.KeyCode.E then keysPressed.E = false
        elseif kc == Enum.KeyCode.Space then keysPressed.Space = false
        elseif kc == Enum.KeyCode.LeftShift then keysPressed.LeftShift = false
        end
    end)
    table.insert(spyConnections, keyInputEnded2)

    if not isMobile then
        local isDragging = false
        local lastMousePos = nil
        local mouseBtn2Down = UserInputService.InputBegan:Connect(function(input)
            if input.UserInputType == Enum.UserInputType.MouseButton2 then
                isDragging = true; lastMousePos = UserInputService:GetMouseLocation()
            end
        end)
        table.insert(spyConnections, mouseBtn2Down)

        local mouseBtn2Up = UserInputService.InputEnded:Connect(function(input)
            if input.UserInputType == Enum.UserInputType.MouseButton2 then
                isDragging = false; lastMousePos = nil
            end
        end)
        table.insert(spyConnections, mouseBtn2Up)

        local mouseMove = UserInputService.InputChanged:Connect(function(input)
            if input.UserInputType == Enum.UserInputType.MouseMovement and isDragging then
                local curr = UserInputService:GetMouseLocation()
                if lastMousePos then
                    local delta = curr - lastMousePos
                    spyRotation = spyRotation - (delta.X * 0.004)
                    spyPitch = math.clamp(spyPitch - (delta.Y * 0.003), -1.2, 1.2)
                end
                lastMousePos = curr
            elseif input.UserInputType == Enum.UserInputType.MouseWheel then
                zoomDistance = math.clamp(zoomDistance - (input.Position.Z * 3), 3, 80)
            end
        end)
        table.insert(spyConnections, mouseMove)
    end

    local streamSyncTimer = 0
    local renderConnection = RunService.RenderStepped:Connect(function(dt)
        if not spyTarget or not spyTarget.Character then spy(nil); return end
        local targetHRP = spyTarget.Character:FindFirstChild("HumanoidRootPart")
        if not targetHRP then spy(nil); return end

        streamSyncTimer = streamSyncTimer + dt
        if streamSyncTimer >= 0.5 then
            streamSyncTimer = 0
            syncLocalCharacterToTarget(targetHRP)
        end

        local currentSpeed = moveSpeed * (keysPressed.LeftShift and 3 or 1)
        local right = CFrame.Angles(0, spyRotation, 0) * Vector3.new(1, 0, 0)
        local forward = CFrame.Angles(0, spyRotation, 0) * Vector3.new(0, 0, -1)

        if keysPressed.W then cameraManualOffset = cameraManualOffset + forward * currentSpeed end
        if keysPressed.S then cameraManualOffset = cameraManualOffset - forward * currentSpeed end
        if keysPressed.A then cameraManualOffset = cameraManualOffset - right * currentSpeed end
        if keysPressed.D then cameraManualOffset = cameraManualOffset + right * currentSpeed end
        if keysPressed.Space then cameraManualOffset = cameraManualOffset + Vector3.new(0, currentSpeed, 0) end
        if keysPressed.Q then cameraManualOffset = cameraManualOffset - Vector3.new(0, currentSpeed, 0) end

        local anyMove = keysPressed.W or keysPressed.S or keysPressed.A or keysPressed.D or keysPressed.Space or keysPressed.Q
        if not anyMove then cameraManualOffset = cameraManualOffset * 0.92 end

        local orbitCF = CFrame.Angles(0, spyRotation, 0) * CFrame.Angles(spyPitch, 0, 0)
        local camOffset = orbitCF * Vector3.new(0, 0, zoomDistance)
        local targetPos = targetHRP.Position + Vector3.new(0, 1.5, 0)
        local camPos = targetPos + camOffset + cameraManualOffset

        Workspace.CurrentCamera.CFrame = CFrame.new(camPos, targetPos)

        if posLabel and posLabel.Parent then
            posLabel.Text = string.format("X:%.0f  Y:%.0f  Z:%.0f", targetHRP.Position.X, targetHRP.Position.Y, targetHRP.Position.Z)
        end
        if hpLabel and hpLabel.Parent then
            local hum = spyTarget.Character:FindFirstChildOfClass("Humanoid")
            if hum then
                hpLabel.Text = string.format("HP: %.0f / %.0f", hum.Health, hum.MaxHealth)
            end
        end
    end)
    table.insert(spyConnections, renderConnection)
end

-- Anti Lag
function antiLag(state)
    AntiLagEnabled = state
    task.spawn(function()
        if state then
            originalGraphics = {
                GlobalShadows = Lighting.GlobalShadows,
                Technology = Lighting.Technology,
                FogEnd = Lighting.FogEnd,
                FogStart = Lighting.FogStart,
                Ambient = Lighting.Ambient,
                OutdoorAmbient = Lighting.OutdoorAmbient,
                Brightness = Lighting.Brightness,
                ShadowSoftness = Lighting.ShadowSoftness,
                EnvironmentDiffuseScale = Lighting.EnvironmentDiffuseScale,
                EnvironmentSpecularScale = Lighting.EnvironmentSpecularScale,
                ClockTime = Lighting.ClockTime,
            }
            pcall(function()
                originalRenderSettings.QualityLevel = settings().Rendering.QualityLevel
                originalRenderSettings.MeshPartDetailLevel = settings().Rendering.MeshPartDetailLevel
            end)

            Lighting.GlobalShadows = false
            pcall(function() Lighting.Technology = Enum.Technology.Compatibility end)
            Lighting.FogEnd = 100000
            Lighting.FogStart = 99999

            for _, part in pairs(Workspace:GetDescendants()) do
                if part:IsA("ParticleEmitter") or part:IsA("Beam") or part:IsA("Trail")
                    or part:IsA("Fire") or part:IsA("Smoke") or part:IsA("Sparkles") then
                    pcall(function()
                        if part.Enabled then
                            part.Enabled = false
                            table.insert(antiLagCleanupList, {obj = part, prop = "Enabled", value = true})
                        end
                    end)
                elseif part:IsA("Decal") then
                    if part.Transparency < 1 then
                        table.insert(antiLagCleanupList, {obj = part, prop = "Transparency", value = part.Transparency})
                        part.Transparency = 1
                    end
                elseif part:IsA("PointLight") or part:IsA("SpotLight") or part:IsA("SurfaceLight") then
                    if part.Enabled then
                        part.Enabled = false
                        table.insert(antiLagCleanupList, {obj = part, prop = "Enabled", value = true})
                    end
                end
            end

            pcall(function()
                settings().Rendering.QualityLevel = Enum.QualityLevel.Level01
                settings().Rendering.MeshPartDetailLevel = Enum.MeshPartDetailLevel.Disabled
            end)

            local conn = Workspace.DescendantAdded:Connect(function(newObj)
                if not AntiLagEnabled then return end
                if newObj:IsA("ParticleEmitter") or newObj:IsA("Beam") or newObj:IsA("Trail")
                    or newObj:IsA("Fire") or newObj:IsA("Smoke") or newObj:IsA("Sparkles") then
                    pcall(function()
                        if newObj.Enabled then
                            newObj.Enabled = false
                            table.insert(antiLagCleanupList, {obj = newObj, prop = "Enabled", value = true})
                        end
                    end)
                elseif newObj:IsA("PointLight") or newObj:IsA("SpotLight") or newObj:IsA("SurfaceLight") then
                    pcall(function()
                        if newObj.Enabled then
                            newObj.Enabled = false
                            table.insert(antiLagCleanupList, {obj = newObj, prop = "Enabled", value = true})
                        end
                    end)
                end
            end)
            table.insert(antiLagConnections, conn)
        else
            for _, conn in ipairs(antiLagConnections) do
                pcall(function() conn:Disconnect() end)
            end
            antiLagConnections = {}

            if originalGraphics and next(originalGraphics) then
                Lighting.GlobalShadows = originalGraphics.GlobalShadows
                Lighting.Technology = originalGraphics.Technology
                Lighting.FogEnd = originalGraphics.FogEnd
                Lighting.FogStart = originalGraphics.FogStart
                Lighting.Ambient = originalGraphics.Ambient
                Lighting.OutdoorAmbient = originalGraphics.OutdoorAmbient
                Lighting.Brightness = originalGraphics.Brightness
                Lighting.ShadowSoftness = originalGraphics.ShadowSoftness
                Lighting.EnvironmentDiffuseScale = originalGraphics.EnvironmentDiffuseScale
                Lighting.EnvironmentSpecularScale = originalGraphics.EnvironmentSpecularScale
                pcall(function() Lighting.ClockTime = originalGraphics.ClockTime end)
            end

            pcall(function()
                if originalRenderSettings.QualityLevel then
                    settings().Rendering.QualityLevel = originalRenderSettings.QualityLevel
                end
                if originalRenderSettings.MeshPartDetailLevel then
                    settings().Rendering.MeshPartDetailLevel = originalRenderSettings.MeshPartDetailLevel
                end
            end)

            for _, entry in ipairs(antiLagCleanupList) do
                pcall(function()
                    if entry.obj and entry.obj.Parent then
                        entry.obj[entry.prop] = entry.value
                    end
                end)
            end
            antiLagCleanupList = {}
            originalGraphics = {}
            originalRenderSettings = {}
        end
    end)
end

-- ESP Checkpoint
local function isCheckpoint(part)
    local name = part.Name:lower()
    local keywords = {"stage", "save", "spawn", "teleport", "goal", "lobby", "checkpoint", "win", "finish"}
    for _, keyword in ipairs(keywords) do
        if string.find(name, keyword) then return true end
    end
    if part.Material == Enum.Material.ForceField or part.Material == Enum.Material.Neon then return true end
    if part:FindFirstChild("Checkpoint") or part:FindFirstChildOfClass("Configuration") then return true end
    if part.Size.Y < 2 and part.Anchored and part.CanCollide and part.Position.Y < 5 then return true end
    return false
end

local function createCheckpointLabel(part)
    if CheckpointLabels[part] or not part:IsA("BasePart") or not isCheckpoint(part) then return end
    local label = Instance.new("TextLabel")
    label.Name = "CheckpointLabel_" .. part.Name
    label.Size = UDim2.new(0, 200, 0, 30)
    label.BackgroundTransparency = 1
    label.TextStrokeTransparency = 0
    label.TextColor3 = Color3.new(0, 1, 0)
    label.Font = Enum.Font.SourceSans
    label.TextSize = 14
    label.Text = string.format("%s\n(%.0f, %.0f, %.0f)", part.Name, part.Position.X, part.Position.Y, part.Position.Z)
    label.Parent = CheckpointGui
    CheckpointLabels[part] = label
end

function espCheckpoint(state)
    CheckpointEspEnabled = state
    if state then
        if CheckpointEspConnection then CheckpointEspConnection:Disconnect(); CheckpointEspConnection = nil end
        if CheckpointAddedConnection then CheckpointAddedConnection:Disconnect(); CheckpointAddedConnection = nil end
        if CheckpointGui and CheckpointGui.Parent then CheckpointGui:Destroy() end
        CheckpointGui = Instance.new("ScreenGui")
        CheckpointGui.Name = "CheckpointESP"
        CheckpointGui.Parent = LocalPlayer:WaitForChild("PlayerGui")
        for _, part in pairs(Workspace:GetDescendants()) do createCheckpointLabel(part) end
        CheckpointAddedConnection = Workspace.DescendantAdded:Connect(function(part)
            if part:IsA("BasePart") then createCheckpointLabel(part) end
        end)
        CheckpointEspConnection = RunService.RenderStepped:Connect(function()
            for checkpoint, label in pairs(CheckpointLabels) do
                if checkpoint and checkpoint.Parent then
                    local vector, onScreen = Camera:WorldToScreenPoint(checkpoint.Position)
                    if onScreen then label.Visible = true; label.Position = UDim2.new(0, vector.X, 0, vector.Y)
                    else label.Visible = false end
                else
                    label:Destroy(); CheckpointLabels[checkpoint] = nil
                end
            end
        end)
    else
        if CheckpointEspConnection then CheckpointEspConnection:Disconnect(); CheckpointEspConnection = nil end
        if CheckpointAddedConnection then CheckpointAddedConnection:Disconnect(); CheckpointAddedConnection = nil end
        for _, label in pairs(CheckpointLabels) do label:Destroy() end
        CheckpointLabels = {}
        if CheckpointGui and CheckpointGui.Parent then CheckpointGui:Destroy() end
        CheckpointGui = nil
    end
end

-- ============================================================
-- ===== UI SYSTEM - SWIPE PAGES =====
-- ============================================================

local UIState = { Toggles = {}, Sliders = {}, Dropdowns = {}, Texts = {} }

local uiBlur = makeUI(Lighting, "BlurEffect", {Size = 20, Enabled = false})

local screenGui = makeUI(LocalPlayer:WaitForChild("PlayerGui"), "ScreenGui", {
    Name = "ModernAdminUI",
    ResetOnSpawn = false,
    ClipsDescendants = false
})

-- Main Frame
local mainFrame = makeUI(screenGui, "Frame", {
    AnchorPoint = Vector2.new(0.5, 0),
    Position = UDim2.new(0.5, 0, 0.2, 0),
    Size = UDim2.new(0, 265, 0, 40),
    BackgroundColor3 = Color3.fromRGB(30, 30, 30),
    BackgroundTransparency = 0.3,
    BorderSizePixel = 0,
    Active = true,
    ClipsDescendants = true
})
makeUI(mainFrame, "UICorner", {CornerRadius = UDim.new(0, 12)})

local shadow = makeUI(mainFrame, "ImageLabel", {
    BackgroundTransparency = 1,
    Image = "rbxassetid://5028857084",
    ImageTransparency = 0.75,
    ScaleType = Enum.ScaleType.Slice,
    SliceCenter = Rect.new(24, 24, 276, 276),
    Size = UDim2.new(1, 0, 1, 0),
    Position = UDim2.new(0, 0, 0, 0),
    ZIndex = -1
})
local stroke = makeUI(mainFrame, "UIStroke", {
    Color = Color3.fromRGB(70, 70, 70),
    Thickness = 1.2,
    Transparency = 0.2
})

-- Glowing border
local glowStroke = makeUI(mainFrame, "UIStroke", {
    Color = Color3.fromRGB(255, 255, 255),
    Thickness = 2.5,
    Transparency = 0,
    ApplyStrokeMode = Enum.ApplyStrokeMode.Border
})
local glowGradient = makeUI(glowStroke, "UIGradient", {
    Color = ColorSequence.new{
        ColorSequenceKeypoint.new(0, Color3.fromRGB(255, 255, 255)),
        ColorSequenceKeypoint.new(0.5, Color3.fromRGB(150, 150, 150)),
        ColorSequenceKeypoint.new(1, Color3.fromRGB(50, 50, 50))
    },
    Rotation = 0
})

local function animateGlowingBorder()
    local rotateTween = TweenService:Create(glowGradient,
        TweenInfo.new(2, Enum.EasingStyle.Sine, Enum.EasingDirection.InOut, -1, false, 0),
        {Rotation = 360}
    )
    spawn(function()
        while true do
            local t1 = TweenService:Create(glowStroke, TweenInfo.new(1.5, Enum.EasingStyle.Sine, Enum.EasingDirection.InOut), {Color = Color3.fromRGB(150,150,150)})
            t1:Play(); t1.Completed:Wait()
            local t2 = TweenService:Create(glowStroke, TweenInfo.new(1.5, Enum.EasingStyle.Sine, Enum.EasingDirection.InOut), {Color = Color3.fromRGB(50,50,50)})
            t2:Play(); t2.Completed:Wait()
            local t3 = TweenService:Create(glowStroke, TweenInfo.new(1.5, Enum.EasingStyle.Sine, Enum.EasingDirection.InOut), {Color = Color3.fromRGB(150,150,150)})
            t3:Play(); t3.Completed:Wait()
            local t4 = TweenService:Create(glowStroke, TweenInfo.new(1.5, Enum.EasingStyle.Sine, Enum.EasingDirection.InOut), {Color = Color3.fromRGB(255,255,255)})
            t4:Play(); t4.Completed:Wait()
        end
    end)
    rotateTween:Play()
    spawn(function()
        while true do
            local p1 = TweenService:Create(glowStroke, TweenInfo.new(1, Enum.EasingStyle.Sine, Enum.EasingDirection.InOut), {Thickness = 3.5})
            p1:Play(); p1.Completed:Wait()
            local p2 = TweenService:Create(glowStroke, TweenInfo.new(1, Enum.EasingStyle.Sine, Enum.EasingDirection.InOut), {Thickness = 2.5})
            p2:Play(); p2.Completed:Wait()
        end
    end)
end
animateGlowingBorder()

-- ===== HEADER =====
local header = makeUI(mainFrame, "Frame", {
    Size = UDim2.new(1, 0, 0, 28),
    BackgroundColor3 = Color3.fromRGB(20, 20, 20),
    BackgroundTransparency = 0.2,
    BorderSizePixel = 0,
    Active = true,
    ZIndex = 5
})
makeUI(header, "UICorner", {CornerRadius = UDim.new(0, 12)})

-- Title label (dynamically updated per page)
local titleLabel = makeUI(header, "TextLabel", {
    Text = "Zero Exploiters",
    Font = Enum.Font.GothamSemibold,
    TextColor3 = Color3.fromRGB(255, 255, 255),
    TextSize = 12,
    BackgroundTransparency = 1,
    Size = UDim2.new(1, -50, 1, 0),
    Position = UDim2.new(0, 8, 0, 0),
    TextXAlignment = Enum.TextXAlignment.Left,
    ZIndex = 6
})

-- Minimize Button
local minimizeButton = makeUI(header, "TextButton", {
    Text = "+",
    Font = Enum.Font.GothamBold,
    TextSize = 16,
    TextColor3 = Color3.fromRGB(255, 255, 255),
    BackgroundTransparency = 0.3,
    BackgroundColor3 = Color3.fromRGB(50, 50, 50),
    Size = UDim2.new(0, 24, 0, 24),
    Position = UDim2.new(1, -30, 0.5, 0),
    AnchorPoint = Vector2.new(0, 0.5),
    ZIndex = 6
})
makeUI(minimizeButton, "UICorner", {CornerRadius = UDim.new(1, 0)})

-- ===== PAGE INDICATOR DOTS =====
local dotsFrame = makeUI(header, "Frame", {
    Size = UDim2.new(0, 30, 0, 10),
    Position = UDim2.new(1, -58, 0.5, 0),
    AnchorPoint = Vector2.new(0, 0.5),
    BackgroundTransparency = 1,
    ZIndex = 6
})
makeUI(dotsFrame, "UIListLayout", {
    FillDirection = Enum.FillDirection.Horizontal,
    HorizontalAlignment = Enum.HorizontalAlignment.Center,
    VerticalAlignment = Enum.VerticalAlignment.Center,
    Padding = UDim.new(0, 4)
})
local dot1 = makeUI(dotsFrame, "Frame", {
    Size = UDim2.new(0, 7, 0, 7),
    BackgroundColor3 = Color3.fromRGB(255, 255, 255),
    BorderSizePixel = 0
})
makeUI(dot1, "UICorner", {CornerRadius = UDim.new(1, 0)})
local dot2 = makeUI(dotsFrame, "Frame", {
    Size = UDim2.new(0, 7, 0, 7),
    BackgroundColor3 = Color3.fromRGB(100, 100, 100),
    BorderSizePixel = 0
})
makeUI(dot2, "UICorner", {CornerRadius = UDim.new(1, 0)})

-- ===== VIEWPORT (Clip frame untuk swipe) =====
-- Ini frame yang terlihat di UI (menampilkan satu halaman sekaligus)
local viewport = makeUI(mainFrame, "Frame", {
    Position = UDim2.new(0, 0, 0, 28),
    Size = UDim2.new(1, 0, 1, -28),
    BackgroundTransparency = 1,
    ClipsDescendants = true
})

-- ===== SWIPE CONTAINER (lebar 2x mainFrame) =====
-- pageContainer bergerak ke kiri/kanan untuk efek swipe
local pageContainer = makeUI(viewport, "Frame", {
    Position = UDim2.new(0, 0, 0, 0),
    Size = UDim2.new(2, 0, 1, 0), -- 2 halaman lebarnya
    BackgroundTransparency = 1
})

-- ===== PAGE 1 - Zero Exploiters Features =====
local page1 = makeUI(pageContainer, "Frame", {
    Position = UDim2.new(0, 0, 0, 0),
    Size = UDim2.new(0.5, 0, 1, 0), -- setengah dari container = 1 lebar UI
    BackgroundTransparency = 1
})

local optionsFrame = makeUI(page1, "ScrollingFrame", {
    Position = UDim2.new(0, 0, 0, 0),
    Size = UDim2.new(1, 0, 1, 0),
    BackgroundTransparency = 1,
    ScrollBarThickness = 6,
    CanvasSize = UDim2.new(0, 0, 0, 0),
    VerticalScrollBarInset = Enum.ScrollBarInset.ScrollBar,
    Active = true
})
local layout = makeUI(optionsFrame, "UIListLayout", {
    Padding = UDim.new(0, 5),
    HorizontalAlignment = Enum.HorizontalAlignment.Center,
    SortOrder = Enum.SortOrder.LayoutOrder,
    VerticalAlignment = Enum.VerticalAlignment.Top
})
layout:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
    optionsFrame.CanvasSize = UDim2.new(0, 0, 0, layout.AbsoluteContentSize.Y + 8)
end)
optionsFrame.Visible = false

-- ===== PAGE 2 - Avatar Changer =====
local page2 = makeUI(pageContainer, "Frame", {
    Position = UDim2.new(0.5, 0, 0, 0),
    Size = UDim2.new(0.5, 0, 1, 0),
    BackgroundTransparency = 1
})

local optionsFrame2 = makeUI(page2, "ScrollingFrame", {
    Position = UDim2.new(0, 0, 0, 0),
    Size = UDim2.new(1, 0, 1, 0),
    BackgroundTransparency = 1,
    ScrollBarThickness = 4,
    ScrollBarImageColor3 = Color3.fromRGB(90, 90, 90),
    CanvasSize = UDim2.new(0, 0, 0, 0),
    VerticalScrollBarInset = Enum.ScrollBarInset.ScrollBar,
    Active = true
})
local layout2 = makeUI(optionsFrame2, "UIListLayout", {
    Padding = UDim.new(0, 5),
    HorizontalAlignment = Enum.HorizontalAlignment.Center,
    SortOrder = Enum.SortOrder.LayoutOrder,
    VerticalAlignment = Enum.VerticalAlignment.Top
})
layout2:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
    optionsFrame2.CanvasSize = UDim2.new(0, 0, 0, layout2.AbsoluteContentSize.Y + 8)
end)
optionsFrame2.Visible = false

-- ===== PAGE MANAGEMENT =====
local currentPage = 1
local totalPages = 2
local pageNames = {"Zero Exploiters", "Avatar Changer"}
local isMinimized = true
local tweenInfo = TweenInfo.new(0.3, Enum.EasingStyle.Quad, Enum.EasingDirection.Out)
local minimizedSize = UDim2.new(0, 265, 0, 40)
-- Per-page maximized heights
local pageMaxHeights = {300, 440}

mainFrame.Size = minimizedSize

local function updateDots()
    dot1.BackgroundColor3 = currentPage == 1 and Color3.fromRGB(255, 255, 255) or Color3.fromRGB(80, 80, 80)
    dot2.BackgroundColor3 = currentPage == 2 and Color3.fromRGB(255, 255, 255) or Color3.fromRGB(80, 80, 80)
    titleLabel.Text = pageNames[currentPage]
end

local function goToPage(pageNum)
    currentPage = pageNum
    updateDots()
    -- Slide pageContainer
    local targetX = -(pageNum - 1) * 0.5 -- Dalam scale, page1=0, page2=-0.5
    TweenService:Create(pageContainer, TweenInfo.new(0.3, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {
        Position = UDim2.new(targetX, 0, 0, 0)
    }):Play()
    -- Update ukuran frame jika sudah maximize
    if not isMinimized then
        local newMaxSize = UDim2.new(0, 265, 0, pageMaxHeights[currentPage])
        TweenService:Create(mainFrame, tweenInfo, {Size = newMaxSize}):Play()
        TweenService:Create(shadow, tweenInfo, {Size = newMaxSize, ImageTransparency = 0.6}):Play()
    end
end

-- ===== SWIPE GESTURE =====
local swipeStartX = nil
local swipeStartY = nil
local swipeThreshold = 40
local swipeVerticalMax = 60
local isSwiping = false

-- Untuk deteksi swipe di area content (bukan header)
viewport.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.Touch or input.UserInputType == Enum.UserInputType.MouseButton1 then
        swipeStartX = input.Position.X
        swipeStartY = input.Position.Y
        isSwiping = true
    end
end)

viewport.InputEnded:Connect(function(input)
    if not isSwiping then return end
    if input.UserInputType == Enum.UserInputType.Touch or input.UserInputType == Enum.UserInputType.MouseButton1 then
        if swipeStartX then
            local deltaX = input.Position.X - swipeStartX
            local deltaY = math.abs(input.Position.Y - swipeStartY)
            if math.abs(deltaX) > swipeThreshold and deltaY < swipeVerticalMax then
                if deltaX < 0 and currentPage < totalPages then
                    goToPage(currentPage + 1)
                elseif deltaX > 0 and currentPage > 1 then
                    goToPage(currentPage - 1)
                end
            end
        end
        swipeStartX = nil
        swipeStartY = nil
        isSwiping = false
    end
end)

-- Juga bisa swipe di header area
header.InputBegan:Connect(function(input)
    -- Hanya swipe horizontal, bukan drag (drag logic sudah dihandle terpisah)
    if input.UserInputType == Enum.UserInputType.Touch then
        swipeStartX = input.Position.X
        swipeStartY = input.Position.Y
        isSwiping = true
    end
end)

-- ===== DRAGGING HEADER =====
local dragging, dragStart, startPos
local function disableControls() return Enum.ContextActionResult.Sink end

header.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
        dragging = true
        dragStart = input.Position
        startPos = mainFrame.Position
        CAS:BindAction("DisableControls", disableControls, false, unpack(Enum.UserInputType:GetEnumItems()))
        input.Changed:Connect(function()
            if input.UserInputState == Enum.UserInputState.End then
                dragging = false
                CAS:UnbindAction("DisableControls")
            end
        end)
    end
end)

UserInputService.InputChanged:Connect(function(input)
    if dragging and (input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch) then
        local delta = input.Position - dragStart
        -- Hanya geser kalau delta signifikan (bukan swipe kecil)
        if math.abs(delta.X) > 5 or math.abs(delta.Y) > 5 then
            mainFrame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
        end
    end
end)

-- ===== OPTION CREATORS (Page 1 - Zero Script style) =====
-- PENTING: Semua creator functions harus didefinisikan SEBELUM dipanggil

local function createToggleOption(name, text, callback)
    local frame = makeUI(optionsFrame, "Frame", {
        Size = UDim2.new(0.95, 0, 0, 35),
        BackgroundColor3 = Color3.fromRGB(40, 40, 40),
        BackgroundTransparency = 0.2,
        BorderSizePixel = 0
    })
    makeUI(frame, "UICorner", {CornerRadius = UDim.new(0, 8)})

    local label = makeUI(frame, "TextLabel", {
        Text = text, Font = Enum.Font.GothamBold,
        TextColor3 = Color3.fromRGB(255, 255, 255), TextSize = 13,
        BackgroundTransparency = 1,
        Size = UDim2.new(0.65, 0, 1, 0),
        Position = UDim2.new(0.03, 0, 0, 0),
        TextXAlignment = Enum.TextXAlignment.Left
    })

    local toggleTrack = makeUI(frame, "Frame", {
        Size = UDim2.new(0, 50, 0, 24),
        Position = UDim2.new(1, -58, 0.5, 0),
        AnchorPoint = Vector2.new(0, 0.5),
        BackgroundColor3 = Color3.fromRGB(70, 70, 70),
        BorderSizePixel = 0
    })
    makeUI(toggleTrack, "UICorner", {CornerRadius = UDim.new(1, 0)})

    local innerShadow = makeUI(toggleTrack, "Frame", {
        Size = UDim2.new(1, -4, 1, -4),
        Position = UDim2.new(0, 2, 0, 2),
        BackgroundColor3 = Color3.fromRGB(20, 20, 20),
        BackgroundTransparency = 0.6,
        BorderSizePixel = 0, ZIndex = 1
    })
    makeUI(innerShadow, "UICorner", {CornerRadius = UDim.new(1, 0)})

    local knob = makeUI(toggleTrack, "Frame", {
        Size = UDim2.new(0, 20, 0, 20),
        Position = UDim2.new(0, 2, 0.5, 0),
        AnchorPoint = Vector2.new(0, 0.5),
        BackgroundColor3 = Color3.fromRGB(255, 255, 255),
        BorderSizePixel = 0, ZIndex = 3
    })
    makeUI(knob, "UICorner", {CornerRadius = UDim.new(1, 0)})

    local knobGlow = makeUI(knob, "ImageLabel", {
        Size = UDim2.new(1, 8, 1, 8),
        Position = UDim2.new(0.5, 0, 0.5, 0),
        AnchorPoint = Vector2.new(0.5, 0.5),
        BackgroundTransparency = 1,
        Image = "rbxassetid://5028857084",
        ImageColor3 = Color3.fromRGB(255, 255, 255),
        ImageTransparency = 0.85,
        ScaleType = Enum.ScaleType.Slice,
        SliceCenter = Rect.new(24, 24, 276, 276),
        ZIndex = 2
    })

    local toggled = false
    local toggleBtn = makeUI(toggleTrack, "TextButton", {
        Size = UDim2.new(1, 0, 1, 0),
        BackgroundTransparency = 1,
        Text = "",
        ZIndex = 4
    })

    toggleBtn.MouseButton1Click:Connect(function()
        toggled = not toggled
        UIState.Toggles[name] = toggled
        if toggled then
            TweenService:Create(toggleTrack, TweenInfo.new(0.2, Enum.EasingStyle.Quad), {BackgroundColor3 = Color3.fromRGB(50, 180, 50)}):Play()
            TweenService:Create(knob, TweenInfo.new(0.2, Enum.EasingStyle.Quad), {Position = UDim2.new(1, -22, 0.5, 0)}):Play()
            TweenService:Create(knobGlow, TweenInfo.new(0.2), {ImageColor3 = Color3.fromRGB(50, 220, 50), ImageTransparency = 0.6}):Play()
        else
            TweenService:Create(toggleTrack, TweenInfo.new(0.2, Enum.EasingStyle.Quad), {BackgroundColor3 = Color3.fromRGB(70, 70, 70)}):Play()
            TweenService:Create(knob, TweenInfo.new(0.2, Enum.EasingStyle.Quad), {Position = UDim2.new(0, 2, 0.5, 0)}):Play()
            TweenService:Create(knobGlow, TweenInfo.new(0.2), {ImageColor3 = Color3.fromRGB(255, 255, 255), ImageTransparency = 0.85}):Play()
        end
        if callback then callback(toggled) end
    end)

    UIState.Toggles[name] = false
    return {frame = frame, toggleBtn = toggleBtn}
end

local function createSlider(name, min, max, default, step, callback)
    step = step or 1
    local frame = makeUI(optionsFrame, "Frame", {
        Size = UDim2.new(0.95, 0, 0, 36),
        BackgroundColor3 = Color3.fromRGB(40, 40, 40),
        BackgroundTransparency = 0.2,
        BorderSizePixel = 0
    })
    makeUI(frame, "UICorner", {CornerRadius = UDim.new(0, 6)})
    makeUI(frame, "TextLabel", {
        Text = name, Font = Enum.Font.Gotham,
        TextColor3 = Color3.fromRGB(255, 255, 255), TextSize = 12,
        BackgroundTransparency = 1,
        Size = UDim2.new(0.35, 0, 1, 0),
        Position = UDim2.new(0.03, 0, 0, 0),
        TextXAlignment = Enum.TextXAlignment.Left
    })

    local sliderFrame = makeUI(frame, "Frame", {
        Size = UDim2.new(0.55, 0, 0.35, 0),
        Position = UDim2.new(0.42, 0, 0.35, 0),
        BackgroundColor3 = Color3.fromRGB(60, 60, 60),
        Active = true
    })
    makeUI(sliderFrame, "UICorner", {CornerRadius = UDim.new(0, 4)})

    local handle = makeUI(sliderFrame, "Frame", {
        Size = UDim2.new(0, 12, 1, 0),
        BackgroundColor3 = Color3.fromRGB(50, 150, 50),
        Active = true
    })
    makeUI(handle, "UICorner", {CornerRadius = UDim.new(0, 6)})

    local valueLabel = makeUI(frame, "TextLabel", {
        Text = tostring(default), Font = Enum.Font.GothamBold,
        TextColor3 = Color3.fromRGB(200, 200, 200), TextSize = 12,
        BackgroundTransparency = 1,
        Size = UDim2.new(0.15, 0, 1, 0),
        Position = UDim2.new(0.88, 0, 0, 0)
    })

    local rel = (default - min) / (max - min)
    handle.Position = UDim2.new(rel, 0, 0, 0)

    local function valueToColor(val)
        local t = (val - min) / (max - min)
        if t < 0.5 then
            local f = t / 0.5
            return Color3.fromRGB(50 + 205 * f, 150 + 105 * f, 50)
        else
            local f = (t - 0.5) / 0.5
            return Color3.fromRGB(255, 255 - 255 * f, 50)
        end
    end

    local draggingSlider = false
    local function updateSlider(input)
        local r = math.clamp((input.Position.X - sliderFrame.AbsolutePosition.X) / sliderFrame.AbsoluteSize.X, 0, 1)
        r = math.floor(r * (max - min) / step + 0.5) * step / (max - min)
        handle.Position = UDim2.new(r, 0, 0, 0)
        local value = min + r * (max - min)
        valueLabel.Text = tostring(math.floor(value))
        handle.BackgroundColor3 = valueToColor(value)
        UIState.Sliders[name] = value
        if callback then callback(value) end
    end

    handle.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            draggingSlider = true; updateSlider(input)
        end
    end)
    handle.InputEnded:Connect(function() draggingSlider = false end)
    sliderFrame.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            draggingSlider = true; updateSlider(input)
        end
    end)
    sliderFrame.InputEnded:Connect(function() draggingSlider = false end)
    UserInputService.InputChanged:Connect(function(input)
        if draggingSlider and (input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch) then
            updateSlider(input)
        end
    end)
    UIState.Sliders[name] = default
    return {frame = frame, valueLabel = valueLabel}
end

local function createTextBox(name, placeholder, callback, autoClear)
    local frame = makeUI(optionsFrame, "Frame", {
        Size = UDim2.new(0.95, 0, 0, 32),
        BackgroundColor3 = Color3.fromRGB(30, 30, 30),
        BorderSizePixel = 0
    })
    makeUI(frame, "UICorner", {CornerRadius = UDim.new(0, 8)})
    makeUI(frame, "TextLabel", {
        Text = name, Font = Enum.Font.Gotham,
        TextColor3 = Color3.fromRGB(200, 200, 200), TextSize = 12,
        BackgroundTransparency = 1,
        Size = UDim2.new(0.35, 0, 1, 0),
        Position = UDim2.new(0.03, 0, 0, 0),
        TextXAlignment = Enum.TextXAlignment.Left
    })

    local box = makeUI(frame, "TextBox", {
        Size = UDim2.new(0.6, 0, 0.75, 0),
        Position = UDim2.new(0.38, 0, 0.125, 0),
        BackgroundColor3 = Color3.fromRGB(40, 40, 40),
        TextColor3 = Color3.fromRGB(150, 150, 150),
        PlaceholderText = placeholder,
        Font = Enum.Font.Gotham, TextSize = 12,
        ClearTextOnFocus = false, BorderSizePixel = 0,
        TextWrapped = false
    })
    makeUI(box, "UICorner", {CornerRadius = UDim.new(0, 6)})

    local defaultText = placeholder
    box.Text = defaultText

    box.Focused:Connect(function()
        TweenService:Create(box, TweenInfo.new(0.2), {BackgroundColor3 = Color3.fromRGB(60, 60, 60)}):Play()
        if box.Text == defaultText then box.Text = ""; box.TextColor3 = Color3.fromRGB(255, 255, 255) end
    end)

    box.FocusLost:Connect(function(enterPressed)
        TweenService:Create(box, TweenInfo.new(0.2), {BackgroundColor3 = Color3.fromRGB(40, 40, 40)}):Play()
        if enterPressed and callback then
            callback(box.Text)
            if autoClear then box.Text = defaultText; box.TextColor3 = Color3.fromRGB(150, 150, 150) end
        end
        if box.Text == "" then box.Text = defaultText; box.TextColor3 = Color3.fromRGB(150, 150, 150) end
        UIState.Texts[name] = box.Text
    end)
    UIState.Texts[name] = ""
    return box
end

local function createDropdown(name, options, callback)
    local dropdownContainer = makeUI(optionsFrame, "Frame", {
        Size = UDim2.new(0.95, 0, 0, 62),
        BackgroundColor3 = Color3.fromRGB(40, 40, 40),
        BackgroundTransparency = 0.2,
        BorderSizePixel = 0, ClipsDescendants = false
    })
    makeUI(dropdownContainer, "UICorner", {CornerRadius = UDim.new(0, 8)})

    makeUI(dropdownContainer, "TextLabel", {
        Text = name, Font = Enum.Font.GothamBold,
        TextColor3 = Color3.fromRGB(255, 255, 255), TextSize = 11,
        BackgroundTransparency = 1,
        Size = UDim2.new(1, -12, 0, 18),
        Position = UDim2.new(0, 8, 0, 4),
        TextXAlignment = Enum.TextXAlignment.Left,
        TextTruncate = Enum.TextTruncate.AtEnd
    })

    local dropdownButton = makeUI(dropdownContainer, "TextButton", {
        Size = UDim2.new(1, -62, 0, 26),
        Position = UDim2.new(0, 6, 0, 28),
        BackgroundColor3 = Color3.fromRGB(50, 50, 50),
        Text = "Select Emote",
        TextColor3 = Color3.fromRGB(200, 200, 200),
        Font = Enum.Font.Gotham, TextSize = 10,
        BorderSizePixel = 0,
        TextXAlignment = Enum.TextXAlignment.Left,
        TextTruncate = Enum.TextTruncate.AtEnd,
        ClipsDescendants = true
    })
    makeUI(dropdownButton, "UICorner", {CornerRadius = UDim.new(0, 6)})
    makeUI(dropdownButton, "UIPadding", {PaddingLeft = UDim.new(0, 7), PaddingRight = UDim.new(0, 22)})

    local arrow = makeUI(dropdownButton, "TextLabel", {
        Text = "", Font = Enum.Font.GothamBold,
        TextColor3 = Color3.fromRGB(180, 180, 180), TextSize = 9,
        BackgroundTransparency = 1,
        Size = UDim2.new(0, 20, 1, 0),
        Position = UDim2.new(1, -20, 0, 0),
        TextXAlignment = Enum.TextXAlignment.Center
    })

    local playButton = makeUI(dropdownContainer, "TextButton", {
        Size = UDim2.new(0, 50, 0, 26),
        Position = UDim2.new(1, -56, 0, 28),
        BackgroundColor3 = Color3.fromRGB(80, 80, 80),
        Text = "Play", TextColor3 = Color3.fromRGB(255, 255, 255),
        Font = Enum.Font.GothamBold, TextSize = 10,
        BorderSizePixel = 0
    })
    makeUI(playButton, "UICorner", {CornerRadius = UDim.new(0, 6)})

    local listWidth = UDim2.new(1, -12, 0, 0)
    local optionsList = makeUI(dropdownContainer, "ScrollingFrame", {
        Size = listWidth,
        Position = UDim2.new(0, 6, 1, 4),
        BackgroundColor3 = Color3.fromRGB(32, 32, 32),
        BorderSizePixel = 0,
        ScrollBarThickness = 3,
        ScrollBarImageColor3 = Color3.fromRGB(100, 100, 100),
        Visible = false, ZIndex = 20,
        CanvasSize = UDim2.new(0, 0, 0, 0),
        ClipsDescendants = true
    })
    makeUI(optionsList, "UICorner", {CornerRadius = UDim.new(0, 6)})
    makeUI(optionsList, "UIStroke", {Color = Color3.fromRGB(70, 70, 70), Thickness = 1, Transparency = 0.5})

    local optionsLayout = makeUI(optionsList, "UIListLayout", {
        Padding = UDim.new(0, 2),
        HorizontalAlignment = Enum.HorizontalAlignment.Center,
        SortOrder = Enum.SortOrder.LayoutOrder
    })
    makeUI(optionsList, "UIPadding", {PaddingTop = UDim.new(0, 3), PaddingBottom = UDim.new(0, 3)})

    local maxVisibleItems = 5
    local itemHeight = 26
    local itemPadding = 2

    optionsLayout:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
        optionsList.CanvasSize = UDim2.new(0, 0, 0, optionsLayout.AbsoluteContentSize.Y + 6)
    end)

    local isOpen = false
    local selectedOption = nil

    for _, option in ipairs(options) do
        local optionButton = makeUI(optionsList, "TextButton", {
            Size = UDim2.new(1, -6, 0, itemHeight),
            BackgroundColor3 = Color3.fromRGB(45, 45, 45),
            Text = option.n, TextColor3 = Color3.fromRGB(200, 200, 200),
            Font = Enum.Font.Gotham, TextSize = 10,
            BorderSizePixel = 0,
            TextXAlignment = Enum.TextXAlignment.Left,
            TextTruncate = Enum.TextTruncate.AtEnd,
            ZIndex = 21
        })
        makeUI(optionButton, "UICorner", {CornerRadius = UDim.new(0, 4)})
        makeUI(optionButton, "UIPadding", {PaddingLeft = UDim.new(0, 8), PaddingRight = UDim.new(0, 6)})

        optionButton.MouseEnter:Connect(function()
            TweenService:Create(optionButton, TweenInfo.new(0.15), {BackgroundColor3 = Color3.fromRGB(62, 62, 62)}):Play()
        end)
        optionButton.MouseLeave:Connect(function()
            TweenService:Create(optionButton, TweenInfo.new(0.15), {BackgroundColor3 = Color3.fromRGB(45, 45, 45)}):Play()
        end)

        optionButton.MouseButton1Click:Connect(function()
            selectedOption = option
            dropdownButton.Text = option.n
            isOpen = false
            TweenService:Create(optionsList, TweenInfo.new(0.2, Enum.EasingStyle.Quad), {Size = listWidth}):Play()
            TweenService:Create(arrow, TweenInfo.new(0.2), {Rotation = 0}):Play()
            task.wait(0.2)
            optionsList.Visible = false
            if callback then callback(option) end
        end)
    end

    local function getTargetHeight()
        local count = math.min(#options, maxVisibleItems)
        return count * itemHeight + (count - 1) * itemPadding + 6
    end

    dropdownButton.MouseButton1Click:Connect(function()
        isOpen = not isOpen
        if isOpen then
            optionsList.Visible = true
            local h = getTargetHeight()
            TweenService:Create(optionsList, TweenInfo.new(0.25, Enum.EasingStyle.Quad), {Size = UDim2.new(1, -12, 0, h)}):Play()
            TweenService:Create(arrow, TweenInfo.new(0.2), {Rotation = 180}):Play()
        else
            TweenService:Create(optionsList, TweenInfo.new(0.18, Enum.EasingStyle.Quad), {Size = listWidth}):Play()
            TweenService:Create(arrow, TweenInfo.new(0.2), {Rotation = 0}):Play()
            task.wait(0.2)
            optionsList.Visible = false
        end
    end)

    playButton.MouseButton1Click:Connect(function()
        if selectedOption then
            if currentPlayButton == playButton and currentAnimationTrack then
                stopCurrentAnimation()
            else
                playAnimation(selectedOption, playButton)
            end
        else
            game.StarterGui:SetCore("SendNotification", {
                Title = "No Emote Selected";
                Text = "Please select an emote first!";
                Duration = 3;
            })
        end
    end)

    UIState.Dropdowns[name] = selectedOption
    return {container = dropdownContainer, button = dropdownButton, list = optionsList, playButton = playButton}
end

-- ============================================================
-- ===== PAGE 2 - AVATAR CHANGER (creator functions dulu) =====
-- ============================================================

local RANDOM_IDS = {978663613,5261700291,1846241644,4993456331,424866237,4312175249,176548116,2270483006,1387071394,2705922253,10115152913,254675749,5282085572,2819144629,2342272463,3877709773,3641789924,5023103942,2298753899,5022264302,66372478,1059023987,2530406197,1992137495,402058769,1208673935,1735121788,3236271187,4797655515,8820259986,1538346377,7081300715,1648676291,2818915354,263336582,1510381464,683993767,1033636351,4004052767,7709627778,5196381745,4983064295,937392108,974086214,6004535943,744532329,2216132529,797871247,442581442,7927897698,4344692203,113408119,4439685307,670917583,5158458988,373349,2994206407,596318021,2574010621,7757117305,1780106970,3872493784,382383327,1921058820,1817915221,2799348313,189511979}

-- Avatar Changer state
local AC_CURRENT_AVATAR  = nil
local AC_ORIGINAL_DESC   = nil
local AC_FAVORITES       = {}
local AC_INPUT_BOX = nil
local ac_favDropFrame    = nil
local ac_favDropLayout   = nil
local ac_favDropBtn      = nil
local ac_favDropEmpty    = nil
local ac_favBtnToggle    = nil
local ac_favDropOpen     = false
local ac_statusLabel     = nil

local AC_UPDATEFAVBTN, AC_UPDATEFAVLIST, AC_SAVEFAVORITES, AC_APPLYAVATAR, AC_MORPHCHAR

-- Save original desc
if LocalPlayer.Character then
    local HUM = LocalPlayer.Character:FindFirstChild("Humanoid")
    if HUM then AC_ORIGINAL_DESC = HUM:GetAppliedDescription() end
end

local function ac_setStatus(text, color)
    if ac_statusLabel then
        ac_statusLabel.Text = "Status: " .. text
        ac_statusLabel.TextColor3 = color or Color3.fromRGB(145, 145, 145)
    end
end

-- Morph Character
AC_MORPHCHAR = function(char, name, id, desc)
    task.spawn(function()
        xpcall(function()
            task.wait(0.3)
            local HUM = char:WaitForChild("Humanoid", 10)
            if not HUM then return end
            for _, v in char:GetDescendants() do
                if v:IsA("Accessory") or v:IsA("Hat") then v:Destroy() end
            end
            for _, v in char:GetChildren() do
                if v:IsA("Shirt") or v:IsA("Pants") or v:IsA("ShirtGraphic") or v:IsA("CharacterMesh") then v:Destroy() end
            end
            local BC = HUM:FindFirstChildOfClass("BodyColors")
            if BC then BC:Destroy() end
            for _, n in {"Torso","Left Arm","Right Arm","Left Leg","Right Leg"} do
                local PT = char:FindFirstChild(n)
                if PT then
                    for _, v in PT:GetChildren() do
                        if v:IsA("SpecialMesh") then v:Destroy() end
                    end
                end
            end
            local HEAD = char:FindFirstChild("Head")
            if HEAD then
                local M = HEAD:FindFirstChildOfClass("SpecialMesh")
                if M then M.MeshId = ""; M.TextureId = "" end
            end
            task.wait(0.1)
            HUM:ApplyDescriptionClientServer(desc)
            HUM.DisplayName = name
        end, warn)
    end)
end

-- Apply Avatar
AC_APPLYAVATAR = function(userid)
    task.spawn(function()
        xpcall(function()
            ac_setStatus("Fetching...", Color3.fromRGB(195, 165, 50))
            local txt = tostring(userid):gsub("%s+", "")
            local ID = tonumber(txt)
            local NAME = nil
            if ID then
                local ok = pcall(function() NAME = Players:GetNameFromUserIdAsync(ID) end)
                if not ok or not NAME then ac_setStatus("User not found!", Color3.fromRGB(155, 45, 45)) return end
            else
                local ok = pcall(function() ID = Players:GetUserIdFromNameAsync(txt); NAME = Players:GetNameFromUserIdAsync(ID) end)
                if not ok or not NAME or not ID then ac_setStatus("User not found!", Color3.fromRGB(155, 45, 45)) return end
            end
            local DESC = Players:GetHumanoidDescriptionFromUserId(ID)
            AC_CURRENT_AVATAR = {id = ID, name = NAME, desc = DESC}
            if LocalPlayer.Character then AC_MORPHCHAR(LocalPlayer.Character, NAME, ID, DESC) end
            LocalPlayer.CharacterAdded:Connect(function(char)
                if AC_CURRENT_AVATAR and AC_CURRENT_AVATAR.id == ID then
                    AC_MORPHCHAR(char, NAME, ID, DESC)
                end
            end)
            ac_setStatus("Applied: " .. NAME, Color3.fromRGB(55, 175, 55))
            AC_UPDATEFAVBTN()
        end, function(err) ac_setStatus("Error!", Color3.fromRGB(155, 45, 45)); warn(err) end)
    end)
end

AC_UPDATEFAVBTN = function()
    if not ac_favBtnToggle then return end
    if not AC_CURRENT_AVATAR then
        ac_favBtnToggle.Text = "Tambah Favorit"
        ac_favBtnToggle.BackgroundColor3 = Color3.fromRGB(42, 42, 42)
        return
    end
    local isFav = false
    for _, v in AC_FAVORITES do
        if v.id == AC_CURRENT_AVATAR.id then isFav = true; break end
    end
    if isFav then
        ac_favBtnToggle.Text = "Favorited "
        ac_favBtnToggle.BackgroundColor3 = Color3.fromRGB(155, 45, 45)
    else
        ac_favBtnToggle.Text = "Tambah Favorit"
        ac_favBtnToggle.BackgroundColor3 = Color3.fromRGB(42, 42, 42)
    end
end

AC_SAVEFAVORITES = function()
    task.spawn(function()
        pcall(function()
            if not isfolder("AvatarChanger") then makefolder("AvatarChanger") end
            writefile("AvatarChanger/favorites.json", HttpService:JSONEncode(AC_FAVORITES))
        end)
    end)
end

AC_UPDATEFAVLIST = function()
    if not ac_favDropFrame then return end
    for _, v in ac_favDropFrame:GetChildren() do
        if v:IsA("Frame") then v:Destroy() end
    end
    if #AC_FAVORITES == 0 then
        ac_favDropEmpty.Visible = true
        return
    end
    ac_favDropEmpty.Visible = false
    for _, fav in AC_FAVORITES do
        local item = makeUI(ac_favDropFrame, "Frame", {
            Size = UDim2.new(0.92, 0, 0, 34),
            BackgroundColor3 = Color3.fromRGB(42, 42, 42),
            BorderSizePixel = 0
        })
        makeUI(item, "UICorner", {CornerRadius = UDim.new(0, 6)})
        makeUI(item, "UIStroke", {Color = Color3.fromRGB(65, 65, 65), Thickness = 1, Transparency = 0.5})
        makeUI(item, "TextLabel", {
            Text = fav.name .. " (" .. fav.id .. ")",
            Font = Enum.Font.Gotham, TextColor3 = Color3.fromRGB(220, 220, 220), TextSize = 11,
            BackgroundTransparency = 1,
            Size = UDim2.new(1, -76, 1, 0),
            Position = UDim2.new(0, 6, 0, 0),
            TextXAlignment = Enum.TextXAlignment.Left,
            TextTruncate = Enum.TextTruncate.AtEnd
        })
        local applyBtn = makeUI(item, "TextButton", {
            Size = UDim2.new(0, 48, 0, 22),
            Position = UDim2.new(1, -72, 0.5, -11),
            BackgroundColor3 = Color3.fromRGB(55, 55, 55),
            BorderSizePixel = 0, AutoButtonColor = false,
            Text = "APPLY", TextColor3 = Color3.fromRGB(220, 220, 220),
            TextSize = 10, Font = Enum.Font.GothamBold
        })
        makeUI(applyBtn, "UICorner", {CornerRadius = UDim.new(0, 5)})
        local removeBtn = makeUI(item, "TextButton", {
            Size = UDim2.new(0, 22, 0, 22),
            Position = UDim2.new(1, -22, 0.5, -11),
            BackgroundColor3 = Color3.fromRGB(155, 45, 45),
            BorderSizePixel = 0, AutoButtonColor = false,
            Text = "", TextColor3 = Color3.fromRGB(220, 220, 220),
            TextSize = 15, Font = Enum.Font.GothamBold
        })
        makeUI(removeBtn, "UICorner", {CornerRadius = UDim.new(0, 5)})

        applyBtn.MouseButton1Click:Connect(function()
            if AC_INPUT_BOX then AC_INPUT_BOX.Text = tostring(fav.id) end
            if LocalPlayer.Character then AC_MORPHCHAR(LocalPlayer.Character, fav.name, fav.id, fav.desc) end
            AC_CURRENT_AVATAR = fav
            ac_setStatus("Applied: " .. fav.name, Color3.fromRGB(55, 175, 55))
            AC_UPDATEFAVBTN()
        end)
        removeBtn.MouseButton1Click:Connect(function()
            local NEW = {}
            for _, v2 in AC_FAVORITES do
                if v2.id ~= fav.id then table.insert(NEW, v2) end
            end
            AC_FAVORITES = NEW; AC_SAVEFAVORITES(); AC_UPDATEFAVLIST(); AC_UPDATEFAVBTN()
        end)
    end
    if ac_favDropOpen then
        local h = math.max(ac_favDropLayout.AbsoluteContentSize.Y + 10, 38)
        ac_favDropFrame.Size = UDim2.new(0.95, 0, 0, h)
    end
end

-- Helper untuk buat UI di page 2
local function ac_makeBtn(parent, text, callback)
    local w = makeUI(parent, "Frame", {
        Size = UDim2.new(0.95, 0, 0, 30),
        BackgroundTransparency = 1, BorderSizePixel = 0
    })
    local btn = makeUI(w, "TextButton", {
        Size = UDim2.new(1, 0, 1, 0),
        BackgroundColor3 = Color3.fromRGB(42, 42, 42),
        BorderSizePixel = 0, AutoButtonColor = false,
        Text = text, TextColor3 = Color3.fromRGB(220, 220, 220),
        TextSize = 12, Font = Enum.Font.GothamBold
    })
    makeUI(btn, "UICorner", {CornerRadius = UDim.new(0, 8)})
    makeUI(btn, "UIStroke", {Color = Color3.fromRGB(65, 65, 65), Thickness = 1, Transparency = 0.3})
    btn.MouseEnter:Connect(function()
        TweenService:Create(btn, TweenInfo.new(0.12), {BackgroundColor3 = Color3.fromRGB(55, 55, 55)}):Play()
    end)
    btn.MouseLeave:Connect(function()
        TweenService:Create(btn, TweenInfo.new(0.12), {BackgroundColor3 = Color3.fromRGB(42, 42, 42)}):Play()
    end)
    btn.MouseButton1Click:Connect(function()
        TweenService:Create(btn, TweenInfo.new(0.07), {BackgroundColor3 = Color3.fromRGB(90, 90, 90)}):Play()
        task.wait(0.1)
        TweenService:Create(btn, TweenInfo.new(0.1), {BackgroundColor3 = Color3.fromRGB(42, 42, 42)}):Play()
        if callback then callback() end
    end)
    return btn
end

local function ac_makeTextBox(parent, labelText, placeholder, callback, autoClear)
    local f = makeUI(parent, "Frame", {
        Size = UDim2.new(0.95, 0, 0, 32),
        BackgroundColor3 = Color3.fromRGB(32, 32, 32),
        BorderSizePixel = 0
    })
    makeUI(f, "UICorner", {CornerRadius = UDim.new(0, 8)})
    makeUI(f, "TextLabel", {
        Text = labelText, Font = Enum.Font.Gotham,
        TextColor3 = Color3.fromRGB(145, 145, 145), TextSize = 12,
        BackgroundTransparency = 1,
        Size = UDim2.new(0.35, 0, 1, 0),
        Position = UDim2.new(0.03, 0, 0, 0),
        TextXAlignment = Enum.TextXAlignment.Left
    })
    local box = makeUI(f, "TextBox", {
        Size = UDim2.new(0.6, 0, 0.75, 0),
        Position = UDim2.new(0.38, 0, 0.125, 0),
        BackgroundColor3 = Color3.fromRGB(42, 42, 42),
        TextColor3 = Color3.fromRGB(145, 145, 145),
        PlaceholderText = placeholder,
        Font = Enum.Font.Gotham, TextSize = 12,
        ClearTextOnFocus = false, BorderSizePixel = 0, TextWrapped = false
    })
    makeUI(box, "UICorner", {CornerRadius = UDim.new(0, 6)})
    local def = placeholder; box.Text = def
    box.Focused:Connect(function()
        TweenService:Create(box, TweenInfo.new(0.2), {BackgroundColor3 = Color3.fromRGB(55, 55, 55)}):Play()
        if box.Text == def then box.Text = ""; box.TextColor3 = Color3.fromRGB(220, 220, 220) end
    end)
    box.InputBegan:Connect(function(i)
        if i.UserInputType == Enum.UserInputType.Touch then box:CaptureFocus() end
    end)
    box.FocusLost:Connect(function(entered)
        TweenService:Create(box, TweenInfo.new(0.2), {BackgroundColor3 = Color3.fromRGB(42, 42, 42)}):Play()
        if entered and callback then
            callback(box.Text)
            if autoClear then box.Text = def; box.TextColor3 = Color3.fromRGB(145, 145, 145) end
        end
        if box.Text == "" then box.Text = def; box.TextColor3 = Color3.fromRGB(145, 145, 145) end
    end)
    return box
end

-- Build page 2 content
function createAvatarChangerPage()
    -- Header page 2 label
    local headerLbl = makeUI(optionsFrame2, "Frame", {
        Size = UDim2.new(0.95, 0, 0, 22),
        BackgroundTransparency = 1, BorderSizePixel = 0
    })
    makeUI(headerLbl, "TextLabel", {
        Text = " Avatar Changer ",
        Font = Enum.Font.GothamBold,
        TextColor3 = Color3.fromRGB(200, 200, 200), TextSize = 12,
        BackgroundTransparency = 1,
        Size = UDim2.new(1, 0, 1, 0),
        TextXAlignment = Enum.TextXAlignment.Center
    })

    -- Input field
    AC_INPUT_BOX = ac_makeTextBox(optionsFrame2, "User", "User ID / Username", function(txt)
        if txt ~= "" then AC_APPLYAVATAR(txt) end
    end, false)

    -- Buttons
    ac_makeBtn(optionsFrame2, "Apply Avatar", function()
        if AC_INPUT_BOX and AC_INPUT_BOX.Text ~= "" and AC_INPUT_BOX.Text ~= "User ID / Username" then
            AC_APPLYAVATAR(AC_INPUT_BOX.Text)
        end
    end)

    ac_makeBtn(optionsFrame2, "Random Avatar ", function()
        local rnd = RANDOM_IDS[math.random(1, #RANDOM_IDS)]
        if AC_INPUT_BOX then AC_INPUT_BOX.Text = tostring(rnd) end
        AC_APPLYAVATAR(rnd)
    end)

    -- Favorites toggle button
    local fw = makeUI(optionsFrame2, "Frame", {
        Size = UDim2.new(0.95, 0, 0, 30),
        BackgroundTransparency = 1, BorderSizePixel = 0
    })
    ac_favBtnToggle = makeUI(fw, "TextButton", {
        Size = UDim2.new(1, 0, 1, 0),
        BackgroundColor3 = Color3.fromRGB(42, 42, 42),
        BorderSizePixel = 0, AutoButtonColor = false,
        Text = "Tambah Favorit",
        TextColor3 = Color3.fromRGB(220, 220, 220), TextSize = 12, Font = Enum.Font.GothamBold
    })
    makeUI(ac_favBtnToggle, "UICorner", {CornerRadius = UDim.new(0, 8)})
    makeUI(ac_favBtnToggle, "UIStroke", {Color = Color3.fromRGB(65, 65, 65), Thickness = 1, Transparency = 0.3})
    ac_favBtnToggle.MouseEnter:Connect(function()
        TweenService:Create(ac_favBtnToggle, TweenInfo.new(0.12), {BackgroundColor3 = Color3.fromRGB(55, 55, 55)}):Play()
    end)
    ac_favBtnToggle.MouseLeave:Connect(function()
        local isFav = AC_CURRENT_AVATAR and (function()
            for _, v in AC_FAVORITES do if v.id == AC_CURRENT_AVATAR.id then return true end end
            return false
        end)()
        TweenService:Create(ac_favBtnToggle, TweenInfo.new(0.12), {BackgroundColor3 = isFav and Color3.fromRGB(155, 45, 45) or Color3.fromRGB(42, 42, 42)}):Play()
    end)
    ac_favBtnToggle.MouseButton1Click:Connect(function()
        if not AC_CURRENT_AVATAR then return end
        local exists, idx = false, 0
        for i, v in AC_FAVORITES do
            if v.id == AC_CURRENT_AVATAR.id then exists = true; idx = i; break end
        end
        if exists then table.remove(AC_FAVORITES, idx) else table.insert(AC_FAVORITES, AC_CURRENT_AVATAR) end
        AC_SAVEFAVORITES(); AC_UPDATEFAVBTN(); AC_UPDATEFAVLIST()
    end)

    -- Reset button
    ac_makeBtn(optionsFrame2, "Reset to Original", function()
        if AC_ORIGINAL_DESC and LocalPlayer.Character then
            local HUM = LocalPlayer.Character:FindFirstChild("Humanoid")
            if HUM then
                HUM:ApplyDescriptionClientServer(AC_ORIGINAL_DESC)
                HUM.DisplayName = LocalPlayer.DisplayName
            end
        end
        AC_CURRENT_AVATAR = nil; AC_UPDATEFAVBTN()
        ac_setStatus("Reset to original", Color3.fromRGB(145, 145, 145))
    end)

    -- Status label
    local sf = makeUI(optionsFrame2, "Frame", {
        Size = UDim2.new(0.95, 0, 0, 22),
        BackgroundTransparency = 1, BorderSizePixel = 0
    })
    ac_statusLabel = makeUI(sf, "TextLabel", {
        Text = "Status: Idle",
        Font = Enum.Font.Gotham, TextColor3 = Color3.fromRGB(145, 145, 145), TextSize = 11,
        BackgroundTransparency = 1,
        Size = UDim2.new(1, 0, 1, 0),
        TextXAlignment = Enum.TextXAlignment.Center
    })

    -- Favorites Dropdown
    local favRow = makeUI(optionsFrame2, "Frame", {
        Size = UDim2.new(0.95, 0, 0, 30),
        BackgroundColor3 = Color3.fromRGB(42, 42, 42),
        BackgroundTransparency = 0.1, BorderSizePixel = 0
    })
    makeUI(favRow, "UICorner", {CornerRadius = UDim.new(0, 6)})
    makeUI(favRow, "TextLabel", {
        Text = "Favorites",
        Font = Enum.Font.Gotham, TextColor3 = Color3.fromRGB(220, 220, 220), TextSize = 12,
        BackgroundTransparency = 1,
        Size = UDim2.new(0.55, 0, 1, 0),
        Position = UDim2.new(0.03, 0, 0, 0),
        TextXAlignment = Enum.TextXAlignment.Left
    })
    ac_favDropBtn = makeUI(favRow, "TextButton", {
        Text = " Buka", Font = Enum.Font.GothamBold, TextSize = 11,
        TextColor3 = Color3.fromRGB(220, 220, 220),
        BackgroundColor3 = Color3.fromRGB(55, 55, 55),
        Size = UDim2.new(0.38, 0, 0.75, 0),
        Position = UDim2.new(0.59, 0, 0.125, 0),
        Active = true
    })
    makeUI(ac_favDropBtn, "UICorner", {CornerRadius = UDim.new(0, 6)})

    ac_favDropFrame = makeUI(optionsFrame2, "Frame", {
        Size = UDim2.new(0.95, 0, 0, 0),
        BackgroundColor3 = Color3.fromRGB(32, 32, 32),
        BackgroundTransparency = 0.08, BorderSizePixel = 0,
        ClipsDescendants = true, Visible = false
    })
    makeUI(ac_favDropFrame, "UICorner", {CornerRadius = UDim.new(0, 8)})
    makeUI(ac_favDropFrame, "UIStroke", {Color = Color3.fromRGB(65, 65, 65), Thickness = 1, Transparency = 0.35})

    ac_favDropLayout = makeUI(ac_favDropFrame, "UIListLayout", {
        Padding = UDim.new(0, 4),
        SortOrder = Enum.SortOrder.LayoutOrder,
        HorizontalAlignment = Enum.HorizontalAlignment.Center
    })
    makeUI(ac_favDropFrame, "UIPadding", {PaddingTop = UDim.new(0, 5), PaddingBottom = UDim.new(0, 5)})

    ac_favDropEmpty = makeUI(ac_favDropFrame, "TextLabel", {
        Text = "Belum ada favorit",
        Font = Enum.Font.Gotham, TextColor3 = Color3.fromRGB(145, 145, 145), TextSize = 11,
        BackgroundTransparency = 1,
        Size = UDim2.new(1, 0, 0, 28),
        TextXAlignment = Enum.TextXAlignment.Center,
        Visible = true
    })

    ac_favDropBtn.MouseButton1Click:Connect(function()
        ac_favDropOpen = not ac_favDropOpen
        if ac_favDropOpen then
            ac_favDropBtn.Text = " Tutup"
            ac_favDropFrame.Visible = true
            local h = math.max(ac_favDropLayout.AbsoluteContentSize.Y + 10, 38)
            ac_favDropFrame.Size = UDim2.new(0.95, 0, 0, h)
        else
            ac_favDropBtn.Text = " Buka"
            ac_favDropFrame.Visible = false
            ac_favDropFrame.Size = UDim2.new(0.95, 0, 0, 0)
        end
    end)

    ac_favDropLayout:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
        if ac_favDropOpen then
            local h = math.max(ac_favDropLayout.AbsoluteContentSize.Y + 10, 38)
            ac_favDropFrame.Size = UDim2.new(0.95, 0, 0, h)
        end
    end)

    -- Load saved favorites
    task.spawn(function()
        pcall(function()
            if not isfolder("AvatarChanger") then makefolder("AvatarChanger") end
            if isfile("AvatarChanger/favorites.json") then
                AC_FAVORITES = HttpService:JSONDecode(readfile("AvatarChanger/favorites.json"))
                task.wait(0.2); AC_UPDATEFAVLIST()
            end
        end)
    end)
end

-- ============================================================
-- ===== MINIMIZE/MAXIMIZE + PAGE CREATORS (setelah semua fungsi didefinisikan) =====
-- ============================================================

local optionsCreated = {false, false}

local function createPage1Options()
    createToggleOption("Noclip", "Noclip", function(state) noclip(state) end)
    createToggleOption("InfiniteJump", "Infinite Jump", function(state) infinityJump(state) end)
    createDropdown("Emotes", EmoteList, function(selectedEmote)
        if selectedEmote then print("Selected emote: " .. selectedEmote.n) end
    end)
    createSlider("WalkSpeed", 16, 200, 16, 1, function(value)
        currentWalkSpeed = value
        if LocalPlayer.Character then applyWalkSpeed(LocalPlayer.Character, value) end
    end)
    createSlider("JumpPower", 50, 300, 50, 1, function(value)
        currentJumpPower = value
        if LocalPlayer.Character then applyJumpPower(LocalPlayer.Character, value) end
    end)
    createToggleOption("GodMode", "God Mode", function(state) godMode(state) end)
    createToggleOption("AntiKick", "Anti-Kick", function(state) antiKick(state) end)
    createToggleOption("NameESP", "Name ESP", function(state) nameEsp(state) end)
    createToggleOption("CheckpointESP", "Checkpoint ESP", function(state) espCheckpoint(state) end)
    createToggleOption("Invisible", "Invisible", function(state) invisible(state) end)
    createToggleOption("AntiLag", "Anti-Lag", function(state) antiLag(state) end)
    createTextBox("SpyPlayer", "Username/Display", function(text) spy(text) end, true)
end

local function toggleMinimize()
    if isMinimized then
        isMinimized = false
        minimizeButton.Text = "-"
        uiBlur.Enabled = true
        optionsFrame.Visible = true
        optionsFrame2.Visible = true
        if not optionsCreated[1] then
            createPage1Options()
            optionsCreated[1] = true
        end
        if not optionsCreated[2] then
            createAvatarChangerPage()
            optionsCreated[2] = true
        end
        local maxSize = UDim2.new(0, 265, 0, pageMaxHeights[currentPage])
        TweenService:Create(mainFrame, tweenInfo, {Size = maxSize}):Play()
        TweenService:Create(shadow, tweenInfo, {Size = maxSize, ImageTransparency = 0.6}):Play()
        TweenService:Create(stroke, tweenInfo, {Transparency = 0, Thickness = 1.8}):Play()
    else
        isMinimized = true
        minimizeButton.Text = "+"
        uiBlur.Enabled = false
        optionsFrame.Visible = false
        optionsFrame2.Visible = false
        TweenService:Create(mainFrame, tweenInfo, {Size = minimizedSize}):Play()
        TweenService:Create(shadow, tweenInfo, {Size = minimizedSize, ImageTransparency = 0.75}):Play()
        TweenService:Create(stroke, tweenInfo, {Transparency = 0.2, Thickness = 1.2}):Play()
    end
end
minimizeButton.MouseButton1Click:Connect(toggleMinimize)

-- ===== CHARACTER EVENT LISTENERS =====
LocalPlayer.CharacterAdded:Connect(function(character)
    applyWalkSpeed(character, currentWalkSpeed)
    applyJumpPower(character, currentJumpPower)
    
    if NoclipEnabled then noclip(true) end
    if InfiniteJumpEnabled then infinityJump(true) end
    if GodModeEnabled then
        local humanoid = character:WaitForChild("Humanoid", 5)
        local hrp = character:WaitForChild("HumanoidRootPart", 5)
        if humanoid and hrp then
            task.wait(0.2)
            setupGodMode(character)
        end
    end
    if AntiKickEnabled then antiKick(true) end
    if NameEspEnabled then nameEsp(true) end
    if InvisibleEnabled then invisible(true) end
    if AntiLagEnabled then antiLag(true) end
    if CheckpointEspEnabled then espCheckpoint(true) end
    
    stopCurrentAnimation()

    -- Avatar changer: update original desc on respawn
    local HUM = character:FindFirstChild("Humanoid")
    if HUM and not AC_ORIGINAL_DESC then
        task.wait(0.5)
        AC_ORIGINAL_DESC = HUM:GetAppliedDescription()
    end
end)

LocalPlayer.CharacterRemoving:Connect(function(character)
    if NoclipEnabled then noclip(false) end
    if InfiniteJumpEnabled then infinityJump(false) end
    if GodModeEnabled then clearGodModeConnections() end
    if AntiKickEnabled then antiKick(false) end
    if InvisibleEnabled then invisible(false) end
    
    if NameTags[LocalPlayer.UserId] then
        if NameTags[LocalPlayer.UserId].billboard then
            NameTags[LocalPlayer.UserId].billboard:Destroy()
        end
        if NameTags[LocalPlayer.UserId].highlight then
            NameTags[LocalPlayer.UserId].highlight:Destroy()
        end
        NameTags[LocalPlayer.UserId] = nil
    end
    
    stopCurrentAnimation()
end)

print(" Zero Exploiters Script Loaded! (Key Verified)")
print(" Swipe UI aktif  2 halaman (Zero Script + Avatar Changer)")
print(" " .. #EmoteList .. " emotes available")
print(" Key System aktif  Script berhasil diverifikasi!")

end -- end loadMainScript()
